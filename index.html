<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>虚拟手机</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="虚拟手机">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23667eea' rx='40'/%3E%3Ctext x='90' y='110' font-size='80' text-anchor='middle' fill='white'%3E📱%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mobile-container">
        <main id="home-screen" class="screen">
            <h1>主页</h1>
            <p>你好，我是 <span id="ai-name-display">...</span></p>
               <div class="app-grid">
                <div class="app-icon" id="open-chat-app"><div class="app-icon-bg">💬</div><span class="app-name">聊天</span></div>
                <div class="app-icon" id="open-wallet-app"><div class="app-icon-bg">💰</div><span class="app-name">钱包</span></div>
                <div class="app-icon" id="open-store-app"><div class="app-icon-bg">🛒</div><span class="app-name">商店</span></div>
                <div class="app-icon" id="open-backpack-app"><div class="app-icon-bg">🎒</div><span class="app-name">背包</span></div>
                <div class="app-icon" id="open-world-book-app"><div class="app-icon-bg">📖</div><span class="app-name">世界书</span></div>
                <div class="app-icon" id="open-settings-app"><div class="app-icon-bg">⚙️</div><span class="app-name">API设置</span></div>
                <div class="app-icon" id="open-general-settings-app"><div class="app-icon-bg">🔧</div><span class="app-name">通用设置</span></div>
            </div> <!-- app-grid 结束 -->

            <!-- 变量替换 Demo（只在首页显示） -->
            <details id="vars-demo" style="margin-top:14px;">
              <summary>变量调试面板</summary>
              <div style="padding:10px;border:1px dashed #bbb;border-radius:8px;font-size:14px;">
                <div><strong>模板（原文）</strong>：
                  现在是 {{time.hour}}:{{time.minute}}，{{ai.name}} 心情 {{ai.mood}}。
                  你有 {{player.inventory.length:0}} 件物品，聊天条数：{{chat.count}}，
                  离线收益/分：{{worldBook.rule001.value:1}}，随机数：{{random.10}}
                </div>
                <div style="margin-top:8px;"><strong>渲染结果</strong>：
                  <span id="vars-demo-result">（加载中…）</span>
                </div>
              </div>
            </details>
        </main>
        
        <section id="chat-screen" class="screen">
            <header class="chat-header"><button id="back-to-home-btn" class="back-btn">‹</button><h2 id="chat-header-title">与零的聊天</h2></header>
            <div id="message-container" class="message-container"></div>
            <form id="chat-input-form" class="chat-input-form">
                <button type="button" id="send-image-btn" class="chat-action-btn">📷</button>
                <input type="text" id="chat-input" placeholder="输入消息...">
                <button type="submit">发送</button>
            </form>
            <input type="file" id="image-input" accept="image/*" style="display: none;">
        </section>

        <section id="wallet-screen" class="screen">
            <header class="wallet-header">
                <button id="wallet-back-btn" class="back-btn">‹</button>
                <h2>我的钱包</h2>
                <button id="wallet-refresh-btn" title="刷新余额">↻</button>
            </header>
            <div class="wallet-content">
                <div class="balance-card">
                    <h3>你的余额</h3>
                    <p><span id="player-money-display">0</span> 金币</p>
                </div>
                <div class="balance-card">
                    <h3><span id="ai-name-wallet-display">AI</span>的余额</h3>
                    <p><span id="ai-money-display">0</span> 金币</p>
                </div>
            </div>
        </section>
        <section id="store-screen" class="screen"> <header class="store-header"><button id="store-back-btn" class="back-btn">‹</button><h2>商店</h2></header> <div class="store-content"><p>你的余额: <span id="store-player-money-display">0</span> 金币</p><div id="item-list" class="item-list"></div></div> </section>
        <section id="backpack-screen" class="screen"> <header class="backpack-header"><button id="backpack-back-btn" class="back-btn">‹</button><h2>我的背包</h2></header> <div id="inventory-list" class="inventory-list"></div> </section>
        
<section id="world-book-screen" class="screen">
    <header class="world-book-header">
        <button id="world-book-back-btn" class="back-btn">‹</button>
        <h2>世界书</h2>
    </header>
    
    <!-- 主界面：条目列表 -->
    <div class="wb-container">
        <!-- 顶部工具栏 -->
        <div class="wb-top-bar">
            <div class="wb-book-selector">
                <select id="wb-current-book" class="wb-select">
                    <option value="">选择世界书...</option>
                </select>
                <button class="wb-btn" onclick="WorldBookV2.createNewBook()">📚 新建</button>
                <button class="wb-btn" onclick="WorldBookV2.editBookSettings()">⚙️ 设置</button>
            </div>
            
            <div class="wb-book-info" id="wb-book-info" style="display:none;">
                <span class="wb-badge" id="wb-book-type">全局</span>
                <span class="wb-entry-count">0 条目</span>
            </div>
        </div>
        
        <!-- 搜索和筛选栏 -->
        <div class="wb-filter-bar">
            <input type="text" id="wb-search" class="wb-search-input" placeholder="搜索条目...">
            <select id="wb-sort" class="wb-select-small">
                <option value="order">按优先级</option>
                <option value="name">按名称</option>
                <option value="updated">按更新时间</option>
            </select>
            <button class="wb-btn-primary" onclick="WorldBookV2.addEntry()">➕ 添加条目</button>
        </div>
        
        <!-- 条目列表 -->
        <div class="wb-entries-container" id="wb-entries-list">
            <!-- 条目卡片将在这里渲染 -->
        </div>
        
        <!-- 空状态提示 -->
        <div class="wb-empty-state" id="wb-empty-state" style="display:none;">
            <div class="wb-empty-icon">📖</div>
            <p>还没有条目</p>
            <button class="wb-btn-primary" onclick="WorldBookV2.addEntry()">创建第一个条目</button>
        </div>
    </div>
</section>

<!-- 条目编辑面板（类似SillyTavern的折叠面板） -->
<div id="wb-entry-panel" class="wb-entry-panel">
    <div class="wb-panel-header">
        <input type="text" id="entry-name" class="wb-entry-name" placeholder="条目名称">
        <div class="wb-panel-actions">
            <button class="wb-icon-btn" onclick="WorldBookV2.toggleEntryEnabled()" title="启用/禁用">
                <span id="entry-enabled-icon">✅</span>
            </button>
            <button class="wb-icon-btn" onclick="WorldBookV2.duplicateEntry()" title="复制">📋</button>
            <button class="wb-icon-btn" onclick="WorldBookV2.deleteEntry()" title="删除">🗑️</button>
            <button class="wb-icon-btn" onclick="WorldBookV2.closePanel()" title="关闭">✖️</button>
        </div>
    </div>
    
    <div class="wb-panel-body">
        <!-- 基础设置 -->
        <div class="wb-field-group">
            <label>触发关键词（Key）</label>
            <input type="text" id="entry-keys" placeholder="关键词1, 关键词2, /正则表达式/">
            <span class="wb-hint">用逗号分隔多个关键词，支持正则表达式</span>
        </div>
        
        <div class="wb-field-group">
            <label>辅助关键词（Secondary Keys）</label>
            <input type="text" id="entry-secondary-keys" placeholder="可选的额外触发词">
        </div>
        
        <div class="wb-field-group">
            <label>内容（Content）</label>
            <textarea id="entry-content" rows="6" placeholder="当触发时注入的内容..."></textarea>
        </div>
        
        <!-- 高级设置（可折叠） -->
        <details class="wb-advanced-section">
            <summary>高级设置</summary>
            
            <div class="wb-field-row">
                <div class="wb-field-group">
                    <label>优先级（Order）</label>
                    <input type="number" id="entry-order" value="100" min="0" max="9999">
                    <span class="wb-hint">数值越大越靠后</span>
                </div>
                
                <div class="wb-field-group">
                    <label>深度（Depth）</label>
                    <input type="number" id="entry-depth" value="4" min="0" max="999">
                    <span class="wb-hint">从底部算起的位置</span>
                </div>
            </div>
            
            <div class="wb-field-group">
                <label>触发条件（Logic）</label>
                <select id="entry-logic">
                    <option value="AND_ANY">AND ANY（任一关键词）</option>
                    <option value="AND_ALL">AND ALL（所有关键词）</option>
                    <option value="NOT_ANY">NOT ANY（排除任一）</option>
                    <option value="NOT_ALL">NOT ALL（排除所有）</option>
                </select>
            </div>
            
            <div class="wb-field-group">
                <label>选择性触发（Selective）</label>
                <div class="wb-checkbox-group">
                    <label><input type="checkbox" id="entry-selective"> 仅在特定条件下触发</label>
                </div>
                <input type="text" id="entry-selective-logic" placeholder="触发条件" style="display:none;">
            </div>
            
            <div class="wb-field-group">
                <label>常驻（Constant）</label>
                <div class="wb-checkbox-group">
                    <label><input type="checkbox" id="entry-constant"> 始终激活（忽略关键词）</label>
                </div>
            </div>
            
            <div class="wb-field-group">
                <label>概率（Probability）</label>
                <input type="range" id="entry-probability" min="0" max="100" value="100">
                <span id="entry-probability-value">100%</span>
            </div>
            
            <div class="wb-field-group">
                <label>位置（Position）</label>
                <select id="entry-position">
                    <option value="before_char">角色定义之前</option>
                    <option value="after_char">角色定义之后</option>
                    <option value="before_example">示例消息之前</option>
                    <option value="after_example">示例消息之后</option>
                    <option value="at_depth">按深度插入</option>
                </select>
            </div>
        </details>
        
        <!-- 递归设置 -->
        <details class="wb-advanced-section">
            <summary>递归扫描</summary>
            
            <div class="wb-field-group">
                <div class="wb-checkbox-group">
                    <label><input type="checkbox" id="entry-disable-recursion"> 禁用递归扫描</label>
                    <label><input type="checkbox" id="entry-scan-depth"> 延伸扫描深度</label>
                </div>
            </div>
            
            <div class="wb-field-group">
                <label>递归深度</label>
                <input type="number" id="entry-recursion-depth" value="2" min="0" max="10">
            </div>
        </details>
        
        <!-- 保存按钮 -->
        <div class="wb-panel-footer">
            <button class="wb-btn-primary" onclick="WorldBookV2.saveEntry()">保存条目</button>
            <button class="wb-btn" onclick="WorldBookV2.testEntry()">测试激活</button>
        </div>
    </div>
</div>

<!-- 世界书设置对话框 -->
<div id="wb-book-settings-dialog" class="wb-dialog" style="display:none;">
    <div class="wb-dialog-content">
        <div class="wb-dialog-header">
            <h3>世界书设置</h3>
            <button class="wb-close-btn" onclick="WorldBookV2.closeBookSettings()">✖️</button>
        </div>
        
        <div class="wb-dialog-body">
            <div class="wb-field-group">
                <label>世界书名称</label>
                <input type="text" id="book-name" placeholder="我的世界书">
            </div>
            
            <div class="wb-field-group">
                <label>描述</label>
                <textarea id="book-description" rows="3" placeholder="这本世界书的用途..."></textarea>
            </div>
            
            <div class="wb-field-group">
                <label>作用范围</label>
                <select id="book-scope">
                    <option value="global">全局（所有角色）</option>
                    <option value="character">绑定角色</option>
                </select>
            </div>
            
            <div class="wb-field-group" id="book-character-select" style="display:none;">
                <label>选择角色</label>
                <select id="book-character">
                    <option value="">选择角色...</option>
                    <option value="ai">零</option>
                    <option value="user">用户</option>
                </select>
            </div>
            
            <div class="wb-field-group">
                <label>扫描深度</label>
                <input type="number" id="book-scan-depth" value="2" min="0" max="100">
                <span class="wb-hint">搜索触发词时回溯的消息数量</span>
            </div>
            
            <div class="wb-field-group">
                <label>Token预算</label>
                <input type="number" id="book-token-budget" value="2048" min="0">
                <span class="wb-hint">分配给世界书的最大token数</span>
            </div>
            
            <div class="wb-field-group">
                <div class="wb-checkbox-group">
                    <label><input type="checkbox" id="book-recursive" checked> 启用递归扫描</label>
                    <label><input type="checkbox" id="book-case-sensitive"> 区分大小写</label>
                    <label><input type="checkbox" id="book-match-whole-words"> 全词匹配</label>
                </div>
            </div>
        </div>
        
        <div class="wb-dialog-footer">
            <button class="wb-btn-primary" onclick="WorldBookV2.saveBookSettings()">保存设置</button>
            <button class="wb-btn" onclick="WorldBookV2.deleteBook()">删除世界书</button>
            <button class="wb-btn" onclick="WorldBookV2.exportBook()">导出</button>
        </div>
    </div>
</div>

<!-- 激活测试对话框 -->
<div id="wb-test-dialog" class="wb-dialog" style="display:none;">
    <div class="wb-dialog-content">
        <div class="wb-dialog-header">
            <h3>测试条目激活</h3>
            <button class="wb-close-btn" onclick="WorldBookV2.closeTestDialog()">✖️</button>
        </div>
        
        <div class="wb-dialog-body">
            <div class="wb-field-group">
                <label>测试文本</label>
                <textarea id="test-text" rows="4" placeholder="输入测试文本..."></textarea>
            </div>
            
            <button class="wb-btn-primary" onclick="WorldBookV2.runTest()">运行测试</button>
            
            <div class="wb-test-results" id="test-results" style="display:none;">
                <h4>测试结果</h4>
                <div id="test-matches"></div>
            </div>
        </div>
    </div>
</div>
<section id="settings-screen" class="screen">
            <header class="settings-header">
                <button id="settings-back-btn" class="back-btn">‹</button>
                <h2>API 设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group preset-manager">
                    <label for="api-preset-select">API 预设</label>
                    <div class="preset-controls">
                        <select id="api-preset-select"></select>
                        <button id="new-preset-btn" class="preset-btn">+</button>
                        <button id="delete-preset-btn" class="preset-btn">-</button>
                    </div>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label for="preset-name-input">预设名称</label>
                    <input type="text" id="preset-name-input" placeholder="例如：我的Gemini">
                </div>
                <div class="form-group">
                    <label for="api-provider-select">API 服务商</label>
                    <select id="api-provider-select">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                        <option value="openai-compatible">OpenAI 兼容 (中转)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">API 地址 / 中转站</label>
                    <input type="text" id="api-endpoint-input" placeholder="例如：https://api.openai.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="api-key-input">API 密钥</label>
                    <input type="password" id="api-key-input" placeholder="在此输入你的密钥">
                </div>
                <div class="form-group">
                    <label for="api-model-input">模型名称</label>
                    <input list="api-models-list" id="api-model-input" name="model" placeholder="点击选择或手动输入...">
                    <datalist id="api-models-list"></datalist>
                    <button id="fetch-models-btn" class="form-button-secondary" style="margin-top: 10px;">拉取可用模型</button>
                </div>
                <div class="api-test-container">
                    <button id="test-api-btn" class="form-button-secondary">测试连接</button>
                    <span id="api-status-indicator"></span>
                </div>
                <button id="save-settings-btn" class="form-button">保存当前预设</button>
                <hr class="separator">
                <div class="form-group">
                    <label>数据备份与恢复</label>
                    <button id="export-data-btn" class="form-button-secondary">导出备份文件</button>
                    <button id="import-data-btn" class="form-button-secondary" style="margin-top: 10px;">导入备份文件</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>

        <section id="general-settings-screen" class="screen">
            <header class="settings-header">
                <button id="general-settings-back-btn" class="back-btn">‹</button>
                <h2>通用设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group">
                    <label for="ai-persona-textarea">AI 核心性格 (AI Persona)</label>
                    <textarea id="ai-persona-textarea" rows="4" placeholder="定义AI的性格、背景故事、说话风格..."></textarea>
                </div>
                <div class="form-group">
                    <label for="my-persona-textarea">我的虚拟形象 (My Persona)</label>
                    <textarea id="my-persona-textarea" rows="3" placeholder="告诉AI，你希望它如何看待你..."></textarea>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label>关联世界书 (为当前聊天)</label>
                    <div id="world-book-linking-container" style="padding: 10px; background: #f0f0f0; border-radius: 6px; min-height: 50px;">
                    </div>
                </div>
                 <hr class="separator">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="chain-of-thought-switch" style="margin-bottom: 0;">启用思维链（让AI后台思考）</label>
                    <input type="checkbox" id="chain-of-thought-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: -10px; padding-left: 20px;">
                    <label for="show-thought-alert-switch" style="margin-bottom: 0; font-size: 13px; color: #666;">显示思维过程（弹窗+对话框）</label>
                    <input type="checkbox" id="show-thought-alert-switch" style="width: auto; height: 18px;">
                </div>
                  <button id="save-general-settings-btn" class="form-button">保存通用设置</button>
                  <button id="debug-settings-btn" class="form-button-secondary" style="margin-top: 10px;">调试设置状态</button>
                  <button id="fix-data-btn" class="form-button-secondary" style="margin-top: 10px;">修复数据兼容性</button>
                  <button id="clean-thought-btn" class="form-button-secondary" style="margin-top: 10px;">清理思维链显示问题</button>
              </div>
          </section>
                <section id="lock-screen" class="screen">
            <div class="time-display">10:24</div>
            <div class="unlock-prompt">点击屏幕以解锁</div>
        </section>
    </div>

   <!-- 模块化的脚本引入 -->
    <!-- 核心模块 -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/database.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ai.js"></script>
    
    <!-- 界面模块 -->
    <script src="js/screens/chat.js"></script>
    <script src="js/screens/wallet.js"></script>
    <script src="js/screens/store.js"></script>
    <script src="js/screens/backpack.js"></script>
    <script src="js/screens/worldbook.js"></script>
    <script src="js/screens/settings.js"></script>
    <script src="js/screens/general-settings.js"></script>

    <!-- 主入口（必须最后加载） -->
    <script src="js/main.js"></script>
    <script>
    // 注册Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('Service Worker registered');
        });
    }
    </script>
</body>
</html>
