<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>虚拟手机</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="虚拟手机">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23667eea' rx='40'/%3E%3Ctext x='90' y='110' font-size='80' text-anchor='middle' fill='white'%3E📱%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mobile-container">
        <main id="home-screen" class="screen">
            <h1>主页</h1>
            <p>你好，我是 <span id="ai-name-display">...</span></p>
               <div class="app-grid">
                <div class="app-icon" id="open-chat-app"><div class="app-icon-bg">💬</div><span class="app-name">聊天</span></div>
                <div class="app-icon" id="open-wallet-app"><div class="app-icon-bg">💰</div><span class="app-name">钱包</span></div>
                <div class="app-icon" id="open-store-app"><div class="app-icon-bg">🛒</div><span class="app-name">商店</span></div>
                <div class="app-icon" id="open-backpack-app"><div class="app-icon-bg">🎒</div><span class="app-name">背包</span></div>
                <div class="app-icon" id="open-world-book-app"><div class="app-icon-bg">📖</div><span class="app-name">世界书</span></div>
                <div class="app-icon" id="open-settings-app"><div class="app-icon-bg">⚙️</div><span class="app-name">API设置</span></div>
                <div class="app-icon" id="open-general-settings-app"><div class="app-icon-bg">🔧</div><span class="app-name">通用设置</span></div>
            </div> <!-- app-grid 结束 -->

            <!-- 变量替换 Demo（只在首页显示） -->
            <details id="vars-demo" style="margin-top:14px;">
              <summary>变量调试面板</summary>
              <div style="padding:10px;border:1px dashed #bbb;border-radius:8px;font-size:14px;">
                <div><strong>模板（原文）</strong>：
                  现在是 {{time.hour}}:{{time.minute}}，{{ai.name}} 心情 {{ai.mood}}。
                  你有 {{player.inventory.length:0}} 件物品，聊天条数：{{chat.count}}，
                  离线收益/分：{{worldBook.rule001.value:1}}，随机数：{{random.10}}
                </div>
                <div style="margin-top:8px;"><strong>渲染结果</strong>：
                  <span id="vars-demo-result">（加载中…）</span>
                </div>
              </div>
            </details>
        </main>
        
        <section id="chat-screen" class="screen">
            <header class="chat-header"><button id="back-to-home-btn" class="back-btn">‹</button><h2 id="chat-header-title">与零的聊天</h2></header>
            <div id="message-container" class="message-container"></div>
            <form id="chat-input-form" class="chat-input-form">
                <button type="button" id="send-image-btn" class="chat-action-btn">📷</button>
                <input type="text" id="chat-input" placeholder="输入消息...">
                <button type="submit">发送</button>
            </form>
            <input type="file" id="image-input" accept="image/*" style="display: none;">
        </section>

        <section id="wallet-screen" class="screen">
            <header class="wallet-header">
                <button id="wallet-back-btn" class="back-btn">‹</button>
                <h2>我的钱包</h2>
                <button id="wallet-refresh-btn" title="刷新余额">↻</button>
            </header>
            <div class="wallet-content">
                <div class="balance-card">
                    <h3>你的余额</h3>
                    <p><span id="player-money-display">0</span> 金币</p>
                </div>
                <div class="balance-card">
                    <h3><span id="ai-name-wallet-display">AI</span>的余额</h3>
                    <p><span id="ai-money-display">0</span> 金币</p>
                </div>
            </div>
        </section>
        <section id="store-screen" class="screen"> <header class="store-header"><button id="store-back-btn" class="back-btn">‹</button><h2>商店</h2></header> <div class="store-content"><p>你的余额: <span id="store-player-money-display">0</span> 金币</p><div id="item-list" class="item-list"></div></div> </section>
        <section id="backpack-screen" class="screen"> <header class="backpack-header"><button id="backpack-back-btn" class="back-btn">‹</button><h2>我的背包</h2></header> <div id="inventory-list" class="inventory-list"></div> </section>
        <section id="world-book-screen" class="screen">
            <header class="world-book-header">
                <button id="world-book-back-btn" class="back-btn">‹</button>
                <h2 id="wb-screen-title">世界书</h2>
                <div class="wb-header-actions">
                    <button id="wb-sandbox-btn" class="wb-icon-btn" title="测试沙盒">🧪</button>
                    <button id="wb-settings-btn" class="wb-icon-btn" title="激活设置">⚙️</button>
                </div>
            </header>

            <!-- 书架视图（主页） -->
            <div id="wb-shelf-view" class="wb-view">
                <div class="wb-toolbar">
                    <button class="wb-btn-primary" onclick="WorldBookScreen.createBook()">➕ 新建世界书</button>
                    <button class="wb-btn" onclick="WorldBookScreen.exportAll()">📤 导出全部</button>
                    <button class="wb-btn" onclick="WorldBookScreen.importAll()">📥 导入</button>
                </div>
                <div id="wb-books-grid" class="wb-books-grid"></div>
            </div>

            <!-- 书本详情视图 -->
            <div id="wb-book-view" class="wb-view" style="display:none;">
                <div class="wb-book-header">
                    <button class="wb-btn" onclick="WorldBookScreen.backToShelf()">← 返回书架</button>
                    <h3 id="wb-current-book-name">书名</h3>
                    <span id="wb-current-book-info" class="wb-book-meta"></span>
                </div>

                <div class="wb-toolbar">
                    <input type="text" id="wb-entry-search" class="wb-search" placeholder="搜索条目...">
                    <select id="wb-entry-sort" class="wb-select">
                        <option value="order-desc">按优先级↓</option>
                        <option value="order-asc">按优先级↑</option>
                        <option value="title">按标题</option>
                        <option value="updated">按更新时间</option>
                    </select>
                    <button class="wb-btn-primary" onclick="WorldBookScreen.createEntry()">➕ 新条目</button>
                    <button class="wb-btn" onclick="WorldBookScreen.exportBook()">📤 导出本书</button>
                    <button class="wb-btn" onclick="WorldBookScreen.importToBook()">📥 导入到本书</button>
                </div>

                <div class="wb-entries-table">
                    <table>
                        <thead>
                            <tr>
                                <th>ID/标题</th>
                                <th>优先级</th>
                                <th>位置</th>
                                <th>策略</th>
                                <th>触发词</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="wb-entries-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- 激活设置视图 -->
            <div id="wb-settings-view" class="wb-view" style="display:none;">
                <div class="wb-settings-header">
                    <button class="wb-btn" onclick="WorldBookScreen.backToShelf()">← 返回</button>
                    <h3>激活设置</h3>
                </div>

                <div class="wb-settings-content">
                    <div class="wb-setting-group">
                        <label>扫描深度 (ScanDepth)</label>
                        <input type="number" id="wb-scan-depth" min="0" max="50" value="8">
                        <span class="wb-hint">回溯多少条消息进行关键词扫描</span>
                    </div>

                    <div class="wb-setting-group">
                        <label>最小激活数 (MinActivations)</label>
                        <input type="number" id="wb-min-activations" min="0" max="20" value="0">
                        <span class="wb-hint">至少激活几条世界书条目</span>
                    </div>

                    <div class="wb-setting-group">
                        <label>最大递归深度 (MaxRecursion)</label>
                        <input type="number" id="wb-max-recursion" min="1" max="10" value="3">
                        <span class="wb-hint">条目间相互触发的最大层数</span>
                    </div>

                    <div class="wb-setting-group">
                        <label>上下文预算 (%)</label>
                        <input type="range" id="wb-budget-percent" min="5" max="50" value="15">
                        <span id="wb-budget-display">15%</span>
                        <span class="wb-hint">分配给世界书的上下文比例</span>
                    </div>

                    <div class="wb-setting-group">
                        <label><input type="checkbox" id="wb-include-names" checked> 包含说话者名字</label>
                        <label><input type="checkbox" id="wb-case-sensitive"> 区分大小写</label>
                        <label><input type="checkbox" id="wb-whole-words" checked> 整词匹配</label>
                        <label><input type="checkbox" id="wb-overflow-alert" checked> 溢出警告</label>
                    </div>

                    <button class="wb-btn-primary" onclick="WorldBookScreen.saveSettingsToStorage()">保存设置</button>
                </div>
            </div>

            <!-- 测试沙盒视图 -->
            <div id="wb-sandbox-view" class="wb-view" style="display:none;">
                <div class="wb-sandbox-header">
                    <button class="wb-btn" onclick="WorldBookScreen.backToShelf()">← 返回</button>
                    <h3>测试沙盒</h3>
                </div>

                <div class="wb-sandbox-content">
                    <div class="wb-sandbox-input">
                        <label>最近上下文</label>
                        <textarea id="wb-test-context" placeholder="输入最近的对话内容..."></textarea>

                        <label>本轮输入</label>
                        <input type="text" id="wb-test-input" placeholder="输入要测试的文本...">

                        <button class="wb-btn-primary" onclick="WorldBookScreen.runTest()">运行测试</button>
                    </div>

                    <div class="wb-sandbox-results">
                        <div class="wb-result-section">
                            <h4>✅ 已注入</h4>
                            <div id="wb-injected-list"></div>
                        </div>

                        <div class="wb-result-section">
                            <h4>⏳ 延迟激活</h4>
                            <div id="wb-delayed-list"></div>
                        </div>

                        <div class="wb-result-section">
                            <h4>🧊 冷却中</h4>
                            <div id="wb-cooldown-list"></div>
                        </div>

                        <div class="wb-result-section">
                            <h4>✂️ 被裁剪</h4>
                            <div id="wb-truncated-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 条目编辑抽屉 -->
        <div id="wb-entry-drawer" class="wb-drawer">
            <div class="wb-drawer-overlay" onclick="WorldBookScreen.closeDrawer()"></div>
            <div class="wb-drawer-content">
                <div class="wb-drawer-header">
                    <h3>编辑条目</h3>
                    <button class="wb-close-btn" onclick="WorldBookScreen.closeDrawer()">×</button>
                </div>

                <div class="wb-drawer-body">
                    <div class="wb-form-group">
                        <label>ID *</label>
                        <input type="text" id="wb-entry-id" placeholder="例如: wb.core.lighthouse">
                    </div>

                    <div class="wb-form-group">
                        <label>标题</label>
                        <input type="text" id="wb-entry-title" placeholder="条目标题（仅显示用）">
                    </div>

                    <div class="wb-form-row">
                        <div class="wb-form-group">
                            <label>作用域</label>
                            <select id="wb-entry-scope">
                                <option value="global">全局</option>
                                <option value="char">角色</option>
                                <option value="event">事件</option>
                            </select>
                        </div>

                        <div class="wb-form-group">
                            <label>说话者</label>
                            <select id="wb-entry-speaker">
                                <option value="any">任意</option>
                                <option value="fang">方亦楷</option>
                                <option value="gu">顾烬寒</option>
                            </select>
                        </div>
                    </div>

                    <div class="wb-form-group">
                        <label>触发词（逗号分隔，支持正则）</label>
                        <input type="text" id="wb-entry-keys" placeholder="玻璃, /\bPain Echo\b/i">
                    </div>

                    <div class="wb-form-group">
                        <label>可选过滤器</label>
                        <input type="text" id="wb-entry-filters" placeholder="AND ANY: 梦境, 回响">
                    </div>

                    <div class="wb-form-group">
                        <label>内容 *</label>
                        <textarea id="wb-entry-content" rows="4" placeholder="实际注入的文本内容..."></textarea>
                    </div>

                    <div class="wb-form-row">
                        <div class="wb-form-group">
                            <label>优先级</label>
                            <input type="number" id="wb-entry-order" value="60" min="0" max="999">
                        </div>

                        <div class="wb-form-group">
                            <label>位置</label>
                            <select id="wb-entry-position">
                                <option value="after_char_defs">角色定义后</option>
                                <option value="before_char_defs">角色定义前</option>
                                <option value="an_top">作者注顶部</option>
                                <option value="an_bottom">作者注底部</option>
                                <option value="depth0_system">@Depth=0 (系统)</option>
                            </select>
                        </div>
                    </div>

                    <div class="wb-form-group">
                        <label>策略</label>
                        <select id="wb-entry-strategy">
                            <option value="trigger">触发式</option>
                            <option value="always">常驻</option>
                            <option value="vector" disabled>向量召回（未来）</option>
                        </select>
                    </div>

                    <div class="wb-form-group">
                        <label>时序控制</label>
                        <div class="wb-timing-row">
                            <input type="number" id="wb-entry-delay" min="0" placeholder="延迟">
                            <input type="number" id="wb-entry-sticky" min="0" placeholder="黏着">
                            <input type="number" id="wb-entry-cooldown" min="0" placeholder="冷却">
                        </div>
                    </div>

                    <div class="wb-form-group">
                        <label>
                            <input type="checkbox" id="wb-entry-recursion" checked> 允许递归
                        </label>
                        <input type="number" id="wb-entry-max-steps" min="1" max="10" value="2" placeholder="最大递归层数">
                    </div>

                    <div class="wb-form-group">
                        <label>标签（逗号分隔）</label>
                        <input type="text" id="wb-entry-tags" placeholder="scope:global, tone:warm">
                    </div>

                    <div class="wb-form-group">
                        <label>
                            <input type="checkbox" id="wb-entry-enabled" checked> 启用此条目
                        </label>
                    </div>

                    <div class="wb-drawer-footer">
                        <button class="wb-btn-primary" onclick="WorldBookScreen.saveEntry()">保存</button>
                        <button class="wb-btn" onclick="WorldBookScreen.deleteEntry()">删除</button>
                        <button class="wb-btn" onclick="WorldBookScreen.closeDrawer()">取消</button>
                    </div>
                </div>
            </div>
        </div>

        <input type="file" id="wb-import-file" accept=".json" style="display:none;">
        
        <section id="settings-screen" class="screen">
            <header class="settings-header">
                <button id="settings-back-btn" class="back-btn">‹</button>
                <h2>API 设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group preset-manager">
                    <label for="api-preset-select">API 预设</label>
                    <div class="preset-controls">
                        <select id="api-preset-select"></select>
                        <button id="new-preset-btn" class="preset-btn">+</button>
                        <button id="delete-preset-btn" class="preset-btn">-</button>
                    </div>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label for="preset-name-input">预设名称</label>
                    <input type="text" id="preset-name-input" placeholder="例如：我的Gemini">
                </div>
                <div class="form-group">
                    <label for="api-provider-select">API 服务商</label>
                    <select id="api-provider-select">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                        <option value="openai-compatible">OpenAI 兼容 (中转)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">API 地址 / 中转站</label>
                    <input type="text" id="api-endpoint-input" placeholder="例如：https://api.openai.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="api-key-input">API 密钥</label>
                    <input type="password" id="api-key-input" placeholder="在此输入你的密钥">
                </div>
                <div class="form-group">
                    <label for="api-model-input">模型名称</label>
                    <input list="api-models-list" id="api-model-input" name="model" placeholder="点击选择或手动输入...">
                    <datalist id="api-models-list"></datalist>
                    <button id="fetch-models-btn" class="form-button-secondary" style="margin-top: 10px;">拉取可用模型</button>
                </div>
                <div class="api-test-container">
                    <button id="test-api-btn" class="form-button-secondary">测试连接</button>
                    <span id="api-status-indicator"></span>
                </div>
                <button id="save-settings-btn" class="form-button">保存当前预设</button>
                <hr class="separator">
                <div class="form-group">
                    <label>数据备份与恢复</label>
                    <button id="export-data-btn" class="form-button-secondary">导出备份文件</button>
                    <button id="import-data-btn" class="form-button-secondary" style="margin-top: 10px;">导入备份文件</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>

        <section id="general-settings-screen" class="screen">
            <header class="settings-header">
                <button id="general-settings-back-btn" class="back-btn">‹</button>
                <h2>通用设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group">
                    <label for="ai-persona-textarea">AI 核心性格 (AI Persona)</label>
                    <textarea id="ai-persona-textarea" rows="4" placeholder="定义AI的性格、背景故事、说话风格..."></textarea>
                </div>
                <div class="form-group">
                    <label for="my-persona-textarea">我的虚拟形象 (My Persona)</label>
                    <textarea id="my-persona-textarea" rows="3" placeholder="告诉AI，你希望它如何看待你..."></textarea>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label>关联世界书 (为当前聊天)</label>
                    <div id="world-book-linking-container" style="padding: 10px; background: #f0f0f0; border-radius: 6px; min-height: 50px;">
                    </div>
                </div>
                 <hr class="separator">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="chain-of-thought-switch" style="margin-bottom: 0;">启用思维链（让AI后台思考）</label>
                    <input type="checkbox" id="chain-of-thought-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: -10px; padding-left: 20px;">
                    <label for="show-thought-alert-switch" style="margin-bottom: 0; font-size: 13px; color: #666;">显示思维过程（弹窗+对话框）</label>
                    <input type="checkbox" id="show-thought-alert-switch" style="width: auto; height: 18px;">
                </div>
                  <button id="save-general-settings-btn" class="form-button">保存通用设置</button>
                  <button id="debug-settings-btn" class="form-button-secondary" style="margin-top: 10px;">调试设置状态</button>
                  <button id="fix-data-btn" class="form-button-secondary" style="margin-top: 10px;">修复数据兼容性</button>
                  <button id="clean-thought-btn" class="form-button-secondary" style="margin-top: 10px;">清理思维链显示问题</button>
              </div>
          </section>
                <section id="lock-screen" class="screen">
            <div class="time-display">10:24</div>
            <div class="unlock-prompt">点击屏幕以解锁</div>
        </section>
    </div>

   <!-- 模块化的脚本引入 -->
    <!-- 核心模块 -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/database.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ai.js"></script>
    
    <!-- 界面模块 -->
    <script src="js/screens/chat.js"></script>
    <script src="js/screens/wallet.js"></script>
    <script src="js/screens/store.js"></script>
    <script src="js/screens/backpack.js"></script>
    <script src="js/screens/worldbook.js"></script>
    <script src="js/screens/settings.js"></script>
    <script src="js/screens/general-settings.js"></script>

    <!-- 主入口（必须最后加载） -->
    <script src="js/main.js"></script>
    <script>
    // 注册Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('Service Worker registered');
        });
    }
    </script>
</body>
</html>
