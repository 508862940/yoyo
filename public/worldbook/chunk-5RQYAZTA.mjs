var f=class{constructor(t={}){this.timedEffectsState=new Map;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...t}}setOptions(t){this.settings={...this.settings,...t}}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let n of t){let i=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};n.sticky&&(i.stickyRemaining=n.sticky),n.cooldown&&(i.cooldownRemaining=n.cooldown),this.timedEffectsState.set(n.id,i)}}process(t,n){let i=performance.now();this.tickTimedEffects();let e=typeof n=="string"?{text:n,currentTime:Date.now()}:{currentTime:Date.now(),...n},o={...this.settings,...t.settings};this.settings=o;let s=this.selectCandidates(t.entries,e);s=this.applyFilters(s,e),s=this.applyTimedEffects(s,e),s=this.applyProbability(s),!!this.settings.recursiveScan&&(this.settings.maxRecursionSteps??0)!==0?s=this.handleRecursion(s,t,e):(this.settings.minActivations??0)>0&&(s=this.minActivationScan(s,t,e,this.settings)),s=this.applyBudget(s,this.settings),this.commitTimedEffects(s);let r=this.distributeToSlots(s),c=performance.now();return{slots:r,activatedEntries:s,totalTokens:this.calculateTotalTokens(s),processTime:c-i}}selectCandidates(t,n){let i=[];for(let e of t){if(!e.enabled)continue;if(e.constant){i.push(this.createActivatedEntry(e,[],0,n));continue}let o=this.matchKeys(e,n.text);if(o.length>0){let s=e.minActivations??this.settings.minActivations??1;if(e.selectiveLogic){let a=e.selectiveLogic.includes("AND")?e.keys.length:1;o.length>=a&&i.push(this.createActivatedEntry(e,o,0,n))}else o.length>=s&&i.push(this.createActivatedEntry(e,o,0,n))}}return i}applyFilters(t,n){return t.filter(i=>{if(i.optionalFilter){let e=i.optionalFilter,o=i.caseSensitive??this.settings.caseSensitive??!1,s=n.text,a=o?s:s.toLowerCase(),r=e.keys.map(l=>o?l:l.toLowerCase()).map(l=>a.includes(l));if(!(e.logic==="AND_ALL"?r.every(Boolean):e.logic==="NOT_ANY"?!r.some(Boolean):e.logic==="NOT_ALL"?!r.every(Boolean):r.some(Boolean)))return!1}return!0})}applyTimedEffects(t,n){let i=[],e=n?.chatHistory?.length??0;for(let o of t){let s=this.timedEffectsState.get(o.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(o.delay&&e<o.delay||s.cooldownRemaining>0)continue;let a={...o};s.stickyRemaining>0&&(a.stickyRemaining=s.stickyRemaining),i.push(a)}return i}applyScoring(t,n){for(let i of t){let e=0;i.constant&&(e+=1e3),e+=(i.priority||0)*100,e+=(i.order||0)*10;for(let o of i.matchedKeys)e+=o.length;if(i.probability!==void 0&&(e+=i.probability*50),i.activationScore=e,this.settings.useGroupScoring&&i.group){let o=this.calculateGroupBonus(i,t);i.groupScore=o,i.activationScore+=o}}return t.sort((i,e)=>(e.activationScore||0)-(i.activationScore||0))}applyProbability(t){return t.filter(n=>n.stickyRemaining&&n.stickyRemaining>0?!0:Math.random()<(n.probability??100)/100)}handleRecursion(t,n,i,e=0){let o=this.settings.maxRecursionSteps??3,s=[...t],a=!1;for(;e<o&&!a;){let r=[];for(let c of s.filter(l=>l.depth===e)){if(!c.content)continue;let l={...i,text:c.content},u=this.selectCandidates(n.entries,l);for(let g of u)if(!(g.delayLevel&&e<g.delayLevel)&&(g.depth=e+1,r.push(g),g.blockFurther)){a=!0;break}if(a)break}if(r.length===0)break;s.push(...r),e++}return s}applyBudget(t,n){let i=n.tokenBudget??2e3,e=n.contextPercent??.7,o=Math.floor(i*e),s=0,a=[];t.sort((r,c)=>(c.activationScore||0)-(r.activationScore||0));for(let r of t){let c=this.estimateTokens(r.content);if(s+c<=o)a.push(r),s+=c;else break}return a}distributeToSlots(t){let n={before_char:[],after_char:[],before_example:[],after_example:[],before_an:[],after_an:[],at_depth:[]};for(let i of t){let e=i.position||"after_char";n[e]?n[e].push(i):n.after_char.push(i)}for(let i in n)n[i].sort((e,o)=>(e.order||0)-(o.order||0));return Object.entries(n).filter(([i,e])=>e.length>0).map(([i,e])=>({position:i,entries:e}))}createActivatedEntry(t,n,i,e){return{...t,matchedKeys:n,depth:i,activationScore:this.calculateActivationScore(t,e.text,n),activationTime:e.currentTime}}matchKeys(t,n){let i=[],e=t.caseSensitive??this.settings.caseSensitive??!1,o=t.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of t.keys||[])this.textMatch(n,s,{caseSensitive:e,wholeWords:o})&&i.push(s);return i}containsCJK(t){return/[\p{Script=Han}\p{Hangul}\p{Hiragana}\p{Katakana}]/u.test(t)}makeWholeWordRegex(t,n){let i=n?"u":"iu";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),i):new RegExp(`(^|[^\\p{L}\\p{N}_])${this.escapeRegex(t)}([^\\p{L}\\p{N}_]|$)`,i)}textMatch(t,n,i={}){let{caseSensitive:e=!1,wholeWords:o=!1}=i;if(n.startsWith("/")&&n.lastIndexOf("/")>0)try{let r=n.lastIndexOf("/"),c=n.slice(1,r),l=n.slice(r+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let s=e?t:t.toLowerCase(),a=e?n:n.toLowerCase();if(o){if(this.makeWholeWordRegex(a,e).test(t))return!0}else if(s.includes(a))return!0;return!1}calculateActivationScore(t,n,i){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let o of i)e+=o.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,n){return t.group?n.filter(e=>e.group===t.group).length*10:0}minActivationScan(t,n,i,e){let o=e.minActivations??1;if(t.length>=o)return t;let s=o-t.length,a=n.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));a.sort((c,l)=>(l.priority||0)-(c.priority||0));let r=[];for(let c=0;c<Math.min(s,a.length);c++){let l=a[c];r.push(this.createActivatedEntry(l,[],0,i))}return[...t,...r]}calculateTotalTokens(t){return t.reduce((n,i)=>n+this.estimateTokens(i.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{f as a};
