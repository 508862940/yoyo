<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldBook Engine Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .file-input-wrapper:hover {
            background: #5a6fd8;
        }

        .file-input-wrapper input {
            position: absolute;
            left: -9999px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item input[type="checkbox"] {
            width: auto;
        }

        .option-item input[type="number"] {
            width: 80px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .results {
            margin-top: 30px;
        }

        .results-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .position-group {
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            overflow: hidden;
        }

        .position-header {
            background: #667eea;
            color: white;
            padding: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .entry-item {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            background: white;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .entry-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .entry-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .entry-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-style: italic;
            border-left: 3px solid #667eea;
        }

        .matched-keys {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .matched-key {
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 6px;
            }

            .main-content {
                padding: 20px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .entry-header {
                flex-direction: column;
                align-items: start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌍 WorldBook Engine Demo</h1>
            <p>零依赖纯前端世界书引擎测试工具</p>
            <div id="wb-status" style="opacity:.7; margin: 10px 0; font-size: 14px; color: #666;"></div>
            <div id="loadedStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 0.9em; display: none;">
                已加载：<span id="loadedBookName"></span>（<span id="loadedEntriesCount"></span> 条目）
            </div>
        </div>

        <div class="main-content">
            <!-- 文件导入区 -->
            <div class="section">
                <h2>📁 导入世界书文件</h2>
                <div class="form-group">
                    <label class="file-input-wrapper">
                        选择 JSON 文件
                        <input type="file" id="fileInput" accept=".json,.worldbook" />
                    </label>
                    <button class="btn btn-secondary" id="loadSampleBtn" style="margin-left: 10px;">
                        加载示例文件
                    </button>
                    <button class="btn btn-info" id="importSelfCheckBtn" style="margin-left: 10px;">
                        导入自检
                    </button>
                </div>
                <div id="fileStatus"></div>
            </div>

            <!-- 输入区 -->
            <div class="section">
                <h2>💬 输入当前消息</h2>
                <div class="form-group">
                    <label for="contextInput">当前对话内容：</label>
                    <textarea 
                        id="contextInput" 
                        placeholder="输入一段话来测试世界书引擎，例如：'我想去巴黎旅游，需要注意什么安全事项？'"
                    ></textarea>
                </div>
            </div>

            <!-- 引擎设置 -->
            <div class="section">
                <h2>⚙️ 引擎参数设置</h2>
                <div class="options-grid">
                    <div class="option-item">
                        <label>扫描深度:</label>
                        <input type="number" id="scanDepth" value="1000" min="1" max="5000">
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="recursive" checked>
                        <label for="recursive">启用递归处理</label>
                    </div>
                    <div class="option-item">
                        <label>最小激活数:</label>
                        <input type="number" id="minActivations" value="1" min="1" max="10">
                    </div>
                    <div class="option-item">
                        <label>最大深度:</label>
                        <input type="number" id="maxDepth" value="3" min="1" max="10">
                    </div>
                    <div class="option-item">
                        <label>最大递归步数:</label>
                        <input type="number" id="maxRecursionSteps" value="10" min="1" max="50">
                    </div>
                    <div class="option-item">
                        <label>令牌预算:</label>
                        <input type="number" id="tokenBudget" value="2000" min="100" max="10000">
                    </div>
                </div>
            </div>

            <!-- 运行按钮 -->
            <div class="section">
                <button class="btn" id="runEngineBtn">🚀 运行引擎</button>
                <button class="btn btn-secondary" id="clearResultsBtn" style="margin-left: 10px;">🗑️ 清空结果</button>
                <button class="btn btn-secondary" id="selfCheckBtn" style="margin-left: 10px;">🔍 导入自检</button>
            </div>

            <!-- 结果显示区 -->
            <div class="results" id="results" style="display: none;">
                <h2>📊 处理结果</h2>
                <div id="resultsSummary"></div>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script src="index.iife.js"></script>
    <script>
        // 位置名映射（把 top/afterSystem/... 映射到标准位）
        const POS_MAP = {
            top:'before_char', beforeMain:'before_an', afterMain:'after_an',
            afterSystem:'after_char', afterExample:'after_example',
            bottom:'after_char', floating:'after_char', unknown:'after_char'
        };
        const mapPos = p => POS_MAP[p] || p || 'after_char';

        // 统一把引擎返回归一化为 [{position, entries: ActivatedEntry[]}]
        function normSlots(out){
            if (Array.isArray(out)) {
                // 可能直接是 ActivatedEntry[]（没有 entries 字段）
                if (out.length && !out[0]?.entries) return [{ position:'after_char', entries: out }];
                return out;
            }
            if (out?.slots){
                if (Array.isArray(out.slots)) return out.slots.map(s => ({ position: mapPos(s.position), entries: s.entries||[] }));
                if (typeof out.slots === 'object') return Object.entries(out.slots).map(([p,arr]) => ({ position: mapPos(p), entries: Array.isArray(arr)?arr:[] }));
            }
            if (Array.isArray(out?.activatedEntries)) return [{ position:'after_char', entries: out.activatedEntries }];
            return [];
        }
        // 防御：有些地方把"槽位值本体"就是数组
        const listOf = s => Array.isArray(s?.entries) ? s.entries : (Array.isArray(s) ? s : []);

        // 全局书籍管理函数
        function setCurrentBook(book){
            window.__currentWorldBook = book;
            try{ localStorage.setItem('worldbook', JSON.stringify(book)); }catch(e){}
            const name = book?.name || '未命名';
            const n    = book?.entries?.length || 0;
            document.getElementById('wb-status')?.replaceChildren(document.createTextNode(`已加载：${name}（${n} 条目）`));
        }

        function getCurrentBook(){
            if (window.__currentWorldBook?.entries?.length) return window.__currentWorldBook;
            try{
                const raw = JSON.parse(localStorage.getItem('worldbook')||'null');
                if (raw) return (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(raw) : raw);
            }catch(e){}
            return (typeof SAMPLE_BOOK!=='undefined'
                ? (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(SAMPLE_BOOK) : SAMPLE_BOOK)
                : null);
        }

        class WorldBookDemo {
            constructor() {
                this.engine = new WorldBookKit.WorldBookEngine({
                    matchWholeWords: false  // 关键修复：禁用全词匹配以支持中文
                });
                this.worldbook = null;
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                document.getElementById('loadSampleBtn').addEventListener('click', this.loadSampleFile.bind(this));
                document.getElementById('runEngineBtn').addEventListener('click', this.runEngine.bind(this));
                document.getElementById('clearResultsBtn').addEventListener('click', this.clearResults.bind(this));
                document.getElementById('selfCheckBtn').addEventListener('click', this.runSelfCheck.bind(this));
                document.getElementById('importSelfCheckBtn').addEventListener('click', this.runImportSelfCheck.bind(this));

                const inputs = ['scanDepth', 'recursive', 'minActivations', 'maxDepth', 'maxRecursionSteps', 'tokenBudget'];
                inputs.forEach(id => {
                    document.getElementById(id).addEventListener('change', this.updateEngineOptions.bind(this));
                });
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await decodeFileToText(file);
                    const raw = JSON.parse(text);
                    const book = (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(raw) : raw);
                    
                    setCurrentBook(book);
                    this.worldbook = book;
                    
                    this.showStatus(`✅ 已加载：${book.name || '未命名'}（${book.entries?.length||0} 条目）`, 'success');
                    this.updateLoadedStatus();
                    this.validateWorldbook();
                } catch (error) {
                    this.showStatus(`❌ 文件加载失败: ${error.message}`, 'error');
                }
            }

            loadSampleFile() {
                try {
                    const book = (window.WorldBookKit?.WorldBookImporter?.import)
                        ? window.WorldBookKit.WorldBookImporter.import(SAMPLE_BOOK)
                        : SAMPLE_BOOK;
                    
                    setCurrentBook(book);
                    this.worldbook = book;
                    
                    this.showStatus(`✅ 已加载：${book.name || '未命名'}（${book.entries?.length||0} 条目）`, 'success');
                    this.updateLoadedStatus();
                    this.validateWorldbook();
                    
                    document.getElementById('contextInput').value = '海南 亚龙湾 天气 餐厅推荐 注意事项';
                } catch (error) {
                    this.showStatus('❌ 无法加载示例文件', 'error');
                }
            }

            validateWorldbook() {
                if (!this.worldbook) return;

                const validation = WorldBookKit.WorldBookImporter.validate(this.worldbook);
                if (!validation.valid) {
                    this.showStatus(`⚠️ 世界书格式有问题: ${validation.errors.join(', ')}`, 'error');
                } else {
                    this.showStatus(`✅ 世界书验证通过，包含 ${this.worldbook.entries.length} 个条目`, 'success');
                    this.updateLoadedStatus();
                }
            }

            updateLoadedStatus() {
                if (!this.worldbook) return;
                
                const statusDiv = document.getElementById('loadedStatus');
                const bookNameSpan = document.getElementById('loadedBookName');
                const entriesCountSpan = document.getElementById('loadedEntriesCount');
                
                bookNameSpan.textContent = this.worldbook.name || '未知世界书';
                entriesCountSpan.textContent = this.worldbook.entries.length;
                statusDiv.style.display = 'block';
            }

            updateEngineOptions() {
                const options = {
                    scanDepth: parseInt(document.getElementById('scanDepth').value),
                    recursive: document.getElementById('recursive').checked,
                    minActivations: parseInt(document.getElementById('minActivations').value),
                    maxDepth: parseInt(document.getElementById('maxDepth').value),
                    maxRecursionSteps: parseInt(document.getElementById('maxRecursionSteps').value),
                    tokenBudget: parseInt(document.getElementById('tokenBudget').value),
                    matchWholeWords: false  // 确保中文匹配正常工作
                };

                this.engine.setOptions(options);
            }

            runEngine() {
                const book = getCurrentBook();
                console.info('[WorldBook] run with', book?.name, book?.entries?.length);
                
                if (!book || !book.entries || book.entries.length === 0) {
                    this.showStatus('❌ 请先加载世界书文件', 'error');
                    return;
                }

                const context = document.getElementById('contextInput').value.trim();
                if (!context) {
                    this.showStatus('❌ 请输入测试内容', 'error');
                    return;
                }

                this.updateEngineOptions();

                try {
                    const startTime = performance.now();
                    const raw = this.engine.process(book, context);
                    const slots = normSlots(raw);
                    const hits = slots.reduce((n, s) => n + listOf(s).length, 0);
                    const endTime = performance.now();
                    const processingTime = (endTime - startTime).toFixed(2);

                    console.debug('[WorldBook] run with', book?.name, book?.entries?.length, 'slots=', slots.length, 'hits=', hits);
                    this.displayResults({slots, activatedEntries: slots.flatMap(s=>listOf(s))}, context, processingTime);
                    this.showStatus(`✅ 引擎运行完成，耗时 ${processingTime}ms`, 'success');
                } catch (error) {
                    this.showStatus(`❌ 引擎运行失败: ${error.message}`, 'error');
                }
            }

            displayResults(result, context, processingTime) {
                const resultsDiv = document.getElementById('results');
                const summaryDiv = document.getElementById('resultsSummary');
                const contentDiv = document.getElementById('resultsContent');

                resultsDiv.style.display = 'block';

                const totalEntries = result.activatedEntries.length;
                const totalSlots = Object.keys(result.slots).filter(key => result.slots[key].length > 0).length;
                const estimatedTokens = result.activatedEntries.reduce((sum, entry) => sum + Math.ceil((entry.content || '').length / 4), 0);

                summaryDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${totalEntries}</div>
                            <div class="stat-label">激活条目</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalSlots}</div>
                            <div class="stat-label">使用位置</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${estimatedTokens}</div>
                            <div class="stat-label">预计令牌</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${processingTime}ms</div>
                            <div class="stat-label">处理时间</div>
                        </div>
                    </div>
                    <p><strong>输入内容:</strong> "${context}"</p>
                `;

                let contentHTML = '';
                const positionNames = {
                    'top': '🔝 顶部',
                    'afterSystem': '🔄 系统后',
                    'afterExample': '📝 示例后',
                    'beforeMain': '⬆️ 主要前',
                    'afterMain': '⬇️ 主要后',
                    'bottom': '🔽 底部',
                    'floating': '🎈 浮动',
                    'unknown': '❓ 未知位置'
                };

                const slots = result.slots || [];
                (Array.isArray(slots) ? slots : Object.entries(slots).map(([p,arr]) => ({position:p, entries:arr}))).forEach(slot => {
                    const entries = listOf(slot);
                    if (entries.length === 0) return;

                    const positionName = positionNames[slot.position] || slot.position;
                    contentHTML += `
                        <div class="position-group">
                            <div class="position-header">
                                <span>${positionName}</span>
                                <span class="position-count">${entries.length} 条</span>
                            </div>
                    `;

                    entries.forEach(entry => {
                        const matchedKeysHTML = entry.matchedKeys && entry.matchedKeys.length > 0 
                            ? `<div class="matched-keys">
                                ${entry.matchedKeys.map(key => `<span class="matched-key">${key}</span>`).join('')}
                               </div>` 
                            : '';

                        contentHTML += `
                            <div class="entry-item">
                                <div class="entry-header">
                                    <div class="entry-title">${entry.name || `条目 ${entry.id}`}</div>
                                </div>
                                <div class="entry-meta">
                                    <span>ID: ${entry.id}</span>
                                    <span>优先级: ${entry.priority || 0}</span>
                                    <span>顺序: ${entry.order || 0}</span>
                                    ${entry.constant ? '<span style="color: #28a745;">常驻</span>' : ''}
                                    ${entry.sticky ? '<span style="color: #fd7e14;">粘性</span>' : ''}
                                    ${entry.group ? `<span>分组: ${entry.group}</span>` : ''}
                                    ${entry.depth !== undefined ? `<span>深度: ${entry.depth}</span>` : ''}
                                    ${entry.activationScore ? `<span>评分: ${Math.round(entry.activationScore)}</span>` : ''}
                                </div>
                                <div class="entry-content">
                                    ${entry.content || '无内容'}
                                </div>
                                ${matchedKeysHTML}
                            </div>
                        `;
                    });

                    contentHTML += '</div>';
                });

                if (contentHTML === '') {
                    contentHTML = '<p style="text-align: center; color: #666; padding: 40px;">没有找到匹配的条目</p>';
                }

                contentDiv.innerHTML = contentHTML;
            }

            clearResults() {
                const resultsDiv = document.getElementById('results');
                resultsDiv.style.display = 'none';
                this.showStatus('🗑️ 结果已清空', 'success');
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('fileStatus');
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }

            runSelfCheck() {
                if (!this.worldbook) {
                    this.showStatus('❌ 请先加载世界书文件', 'error');
                    return;
                }

                const book = this.worldbook;
                const entries = book.entries || [];

                // 统计信息
                const stats = {
                    书名: book.name || '未命名',
                    总条目数: entries.length,
                    keys为空的条目数: 0,
                    enabled为false的条目数: 0,
                    位置统计: {}
                };

                const emptyKeysEntries = [];
                const disabledEntries = [];

                const safeEntries = Array.isArray(entries) ? entries : [];
                safeEntries.forEach(entry => {
                    // 检查 keys 为空
                    if (!entry.keys || entry.keys.length === 0) {
                        stats.keys为空的条目数++;
                        if (emptyKeysEntries.length < 5) {
                            emptyKeysEntries.push({
                                id: entry.id,
                                name: entry.name || '无名称'
                            });
                        }
                    }

                    // 检查 enabled 为 false
                    if (entry.enabled === false) {
                        stats.enabled为false的条目数++;
                        if (disabledEntries.length < 5) {
                            disabledEntries.push({
                                id: entry.id,
                                name: entry.name || '无名称'
                            });
                        }
                    }

                    // 统计位置
                    const position = entry.position || 'after_char';
                    stats.位置统计[position] = (stats.位置统计[position] || 0) + 1;
                });

                // 随机取 3 个条目的详细信息
                const sampleEntries = [];
                const shuffled = [...safeEntries].sort(() => 0.5 - Math.random());
                for (let i = 0; i < Math.min(3, shuffled.length); i++) {
                    const entry = shuffled[i];
                    sampleEntries.push({
                        id: entry.id,
                        name: entry.name || '无名称',
                        keys: (entry.keys || []).join(', '),
                        content_preview: (entry.content || '').slice(0, 20) + (entry.content && entry.content.length > 20 ? '...' : '')
                    });
                }

                // 输出到控制台
                console.group('🔍 世界书导入自检报告');
                console.table([stats]);
                
                if (emptyKeysEntries.length > 0) {
                    console.warn(`keys 为空的条目（前 ${emptyKeysEntries.length} 个）:`, emptyKeysEntries);
                }
                
                if (disabledEntries.length > 0) {
                    console.warn(`enabled=false 的条目（前 ${disabledEntries.length} 个）:`, disabledEntries);
                }
                
                console.log('位置分布:', stats.位置统计);
                console.log('随机样本条目:', sampleEntries);
                console.groupEnd();

                // 显示简要结果
                const summary = `📊 自检完成！总条目：${stats.总条目数}，keys为空：${stats.keys为空的条目数}，已禁用：${stats.enabled为false的条目数}`;
                this.showStatus(summary, 'success');
            }

            runImportSelfCheck() {
                const book = getCurrentBook();
                if (!book?.entries) {
                    this.showStatus('❌ 尚未加载世界书', 'error');
                    return;
                }
                
                const entries = Array.isArray(book.entries) ? book.entries : [];
                const emptyKeys = entries.filter(e => !Array.isArray(e.keys) || e.keys.length === 0).slice(0, 5);
                
                console.group('世界书导入自检');
                console.log('keys 为空的条目（前 5 个）:', emptyKeys);
                console.groupEnd();
                
                this.showStatus(`✅ 自检完成：keys 为空 ${emptyKeys.length} 条（详情看控制台）`, 'success');
            }
        }

        // 通用编码检测和BOM移除函数
        async function decodeFileToText(file) {
            const buf = await file.arrayBuffer();
            const tryList = [
                {enc:'utf-8', bom:true},
                {enc:'utf-16le', bom:true},
                {enc:'utf-16be', bom:true},
                {enc:'gb18030'},
                {enc:'gbk'},
                {enc:'big5'},
            ];
            for (const opt of tryList) {
                try {
                    let t = new TextDecoder(opt.enc, {fatal:false}).decode(buf);
                    t = stripBOM(t);
                    JSON.parse(t); // 试解析
                    return t;      // 成功就返回
                } catch (e) { /* try next */ }
            }
            // 都不行时，最后再用 utf-8 宽松解码返回（给用户提示）
            return stripBOM(new TextDecoder('utf-8').decode(buf));
        }

        function stripBOM(str){ return str.replace(/^\uFEFF/, ''); }

        // 内嵌示例数据，避免 fetch 问题
        const SAMPLE_BOOK = {
            "name": "Travel World Book",
            "description": "A comprehensive world book for travel scenarios",
            "version": "1.0.0",
            "entries": [
                {
                    "id": "wbe_001",
                    "name": "Constant Travel Context",
                    "keys": [],
                    "content": "The world is vast and filled with wonders to explore. Every journey begins with a single step, and every destination holds unique stories and experiences.",
                    "constant": true,
                    "position": "top",
                    "priority": 100,
                    "order": 1,
                    "comment": "Always active travel context"
                },
                {
                    "id": "wbe_002",
                    "name": "Paris Location",
                    "keys": ["Paris", "Eiffel Tower", "France", "French"],
                    "content": "Paris, the City of Light, is renowned for its art, fashion, gastronomy, and culture. The Eiffel Tower stands as its iconic landmark, while the Seine River flows through the heart of the city. Cafés line the streets, and museums like the Louvre house world-famous artworks.",
                    "position": "afterSystem",
                    "priority": 80,
                    "order": 10,
                    "group": "locations",
                    "probability": 0.9,
                    "sticky": true,
                    "cooldown": 3,
                    "comment": "High priority Paris information"
                },
                {
                    "id": "wbe_003",
                    "name": "Tokyo Location",
                    "keys": ["Tokyo", "Japan", "Japanese", "Shibuya", "Mount Fuji"],
                    "content": "Tokyo is a bustling metropolis where traditional culture meets cutting-edge technology. From the busy crossing at Shibuya to the serene temples, Tokyo offers contrasts at every turn. Mount Fuji can be seen on clear days, and the city's cuisine ranges from street food to Michelin-starred restaurants.",
                    "position": "afterSystem",
                    "priority": 75,
                    "order": 11,
                    "group": "locations",
                    "probability": 0.85,
                    "delay": 2,
                    "comment": "Tokyo travel information"
                },
                {
                    "id": "wbe_004",
                    "name": "New York Location",
                    "keys": ["New York", "NYC", "Manhattan", "Statue of Liberty", "Central Park"],
                    "content": "New York City, the Big Apple, never sleeps. Manhattan's skyline is iconic, Central Park provides green respite, and the Statue of Liberty symbolizes freedom. Broadway shows, world-class museums, and diverse neighborhoods make it a cultural melting pot.",
                    "position": "afterSystem",
                    "priority": 70,
                    "order": 12,
                    "group": "locations",
                    "probability": 0.8,
                    "comment": "New York City details"
                },
                {
                    "id": "wbe_013",
                    "name": "海南亚龙湾",
                    "keys": ["海南", "亚龙湾", "三亚", "Hainan", "Yalong Bay", "Sanya"],
                    "content": "海南亚龙湾是中国著名的热带海滨旅游胜地，拥有7公里长的银白色海滩和清澈的海水。这里气候宜人，年平均气温25.5°C，是度假的理想选择。亚龙湾周边有众多度假酒店和水上运动设施。",
                    "position": "afterSystem",
                    "priority": 85,
                    "order": 13,
                    "group": "locations",
                    "probability": 0.95,
                    "sticky": 2,
                    "comment": "海南亚龙湾旅游信息"
                },
                {
                    "id": "wbe_005",
                    "name": "Travel Safety Tips",
                    "keys": ["safety", "secure", "dangerous", "risk", "emergency", "安全", "注意事项", "危险"],
                    "content": "Travel safety is paramount. Always keep copies of important documents, stay aware of your surroundings, use reputable transportation, and inform someone of your itinerary. Research local customs and potential risks before traveling.",
                    "position": "beforeMain",
                    "priority": 90,
                    "order": 5,
                    "selectiveLogic": "AND",
                    "minActivations": 1,
                    "comment": "Important safety information"
                },
                {
                    "id": "wbe_006",
                    "name": "Hotel Booking",
                    "keys": ["hotel", "accommodation", "booking", "reservation", "stay"],
                    "content": "When booking hotels, consider location, amenities, reviews, and cancellation policies. Book in advance for popular destinations and during peak seasons. Compare prices across platforms and read recent guest reviews.",
                    "position": "afterExample",
                    "priority": 60,
                    "order": 20,
                    "probability": 0.7,
                    "comment": "Hotel booking advice"
                },
                {
                    "id": "wbe_007",
                    "name": "Flight Information",
                    "keys": ["flight", "airplane", "airport", "airline", "departure", "arrival"],
                    "content": "Flight planning involves comparing prices, checking baggage policies, and considering departure times. Arrive at airports early, especially for international flights. Check-in online when possible and download airline apps for updates.",
                    "position": "afterExample",
                    "priority": 65,
                    "order": 21,
                    "recursive": true,
                    "maxRecursionSteps": 2,
                    "comment": "Flight travel information"
                },
                {
                    "id": "wbe_008",
                    "name": "Local Transportation",
                    "keys": ["taxi", "bus", "subway", "metro", "transportation", "public transport"],
                    "content": "Local transportation options vary by destination. Research metro/subway systems, bus routes, and taxi services. Consider ride-sharing apps, bike rentals, or walking for short distances. Purchase travel cards for frequent public transport use.",
                    "position": "afterMain",
                    "priority": 50,
                    "order": 30,
                    "nonRecursable": true,
                    "comment": "Transportation within cities"
                },
                {
                    "id": "wbe_009",
                    "name": "Currency Exchange",
                    "keys": ["money", "currency", "exchange", "ATM", "cash", "credit card"],
                    "content": "Handle currency wisely when traveling. Use ATMs for better exchange rates than currency counters. Notify banks of travel plans to avoid card blocks. Carry some cash for places that don't accept cards, but don't carry excessive amounts.",
                    "position": "afterMain",
                    "priority": 55,
                    "order": 31,
                    "blockFurther": true,
                    "delayLevel": 1,
                    "comment": "Financial advice for travelers"
                },
                {
                    "id": "wbe_010",
                    "name": "Cultural Etiquette",
                    "keys": ["culture", "etiquette", "customs", "manners", "respect", "local traditions"],
                    "content": "Respect local cultures and customs. Learn basic phrases in the local language, dress appropriately for religious sites, understand tipping customs, and be mindful of photography restrictions. Research cultural norms before visiting.",
                    "position": "floating",
                    "priority": 40,
                    "order": 40,
                    "probability": 0.6,
                    "maxDepth": 2,
                    "comment": "Cultural awareness for respectful travel"
                },
                {
                    "id": "wbe_011",
                    "name": "Food and Dining",
                    "keys": ["food", "restaurant", "cuisine", "dining", "local food", "eating", "餐厅", "美食", "餐厅推荐"],
                    "content": "Exploring local cuisine is a highlight of travel. Try street food from reputable vendors, make reservations at popular restaurants, consider dietary restrictions and allergies, and be adventurous with new flavors while being cautious with food safety.",
                    "position": "bottom",
                    "priority": 45,
                    "order": 50,
                    "comment": "Culinary travel experiences"
                },
                {
                    "id": "wbe_012",
                    "name": "Weather Considerations",
                    "keys": ["weather", "climate", "temperature", "rain", "season", "forecast", "天气", "气候", "温度"],
                    "content": "Weather significantly impacts travel experiences. Check forecasts before departure, pack appropriate clothing for the climate, consider seasonal variations and monsoons, and have backup indoor activities for rainy days.",
                    "position": "bottom",
                    "priority": 35,
                    "order": 51,
                    "probability": 0.75,
                    "comment": "Weather planning for travel"
                }
            ],
            "settings": {
                "defaultScanDepth": 1000,
                "defaultRecursive": true,
                "defaultMinActivations": 1,
                "defaultMaxDepth": 3,
                "defaultMaxRecursionSteps": 10,
                "defaultTokenBudget": 2000,
                "matchWholeWords": false
            },
            "metadata": {
                "created": "2025-09-09",
                "author": "WorldBook System",
                "tags": ["travel", "tourism", "culture", "safety"],
                "totalEntries": 13
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            new WorldBookDemo();
        });
    </script>
</body>
</html>