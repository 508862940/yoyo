var v=class{constructor(t){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let i=t.seed>>>0||1;this.rand=()=>((i=1664525*i+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(t){this.runtimeOptions={...this.runtimeOptions,...t}}process(t,i){let s={...this.getDefaultSettings(),...t.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(s.recursiveScan=!!this.runtimeOptions.recursive);let e=this.activate({...t,settings:s},{scanText:i,chatHistory:[],generationType:"Normal"}),n=e.flatMap(o=>o.entries),a=n.map(o=>o.content).join(`
`),r=this.calculateTotalTokens(n);return{activatedEntries:n,slots:e,finalPrompt:a,totalTokens:r}}activate(t,i){this.tickTimedEffects();let s=t.settings||this.getDefaultSettings(),e=this.selectCandidates(t.entries,i,s);e=this.applyFilters(e,i,s),e=this.applyTimedEffects(e,s),e=this.applyProbability(e),e=this.resolveInclusionGroups(e),e=this.applyScoring(e,i,s),e=this.applyBudget(e,s);let n=e.some(r=>r.nonRecursable||r.blockFurther);this.commitTimedEffects(e);let a=!!s.recursiveScan&&(s.maxRecursionSteps??0)>0;return!n&&a?e=this.recursiveScan(e,t,i,s):!a&&(s.minActivations??0)>0&&(e=this.minActivationScan(e,t,i,s)),this.distributeToSlots(e)}selectCandidates(t,i,s){let e=[],n=i.scanText||"";for(let a of t){if(!a.enabled)continue;if(a.constant){e.push(this.createActivatedEntry(a,[],0,i));continue}let r=this.matchKeys(a,n,s);if(r.length>0){let o=a.minActivations??s.minActivations??1;if(a.selectiveLogic){let c=a.selectiveLogic.includes("AND")?a.keys.length:1;r.length>=c&&e.push(this.createActivatedEntry(a,r,0,i))}else r.length>=o&&e.push(this.createActivatedEntry(a,r,0,i))}}return e}applyFilters(t,i,s){return t.filter(e=>{if(e.optionalFilter){let n=e.optionalFilter,a=e.caseSensitive??s.caseSensitive??!1,r=i.scanText||"",o=a?r:r.toLowerCase(),c=n.keys.map(p=>a?p:p.toLowerCase()).map(p=>o.includes(p));if(!(n.logic==="AND_ALL"?c.every(Boolean):n.logic==="NOT_ANY"?!c.some(Boolean):n.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let i of t){let s=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};i.sticky&&(s.stickyRemaining=i.sticky),i.cooldown&&(s.cooldownRemaining=i.cooldown),this.timedEffectsState.set(i.id,s)}}applyTimedEffects(t,i){let s=[],e=i?.chatHistory?.length??0;for(let n of t){let a=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(n.delay&&e<n.delay||a.cooldownRemaining>0)continue;let r={...n};a.stickyRemaining>0&&(r.stickyRemaining=a.stickyRemaining),s.push(r)}return s}applyScoring(t,i,s){for(let e of t){let n=0;e.constant&&(n+=1e3),n+=(e.priority||0)*100,n+=(e.order||0)*10;for(let a of e.matchedKeys)n+=a.length;if(e.probability!==void 0&&(n+=e.probability*50),e.activationScore=n,e.score=n,s.useGroupScoring&&e.group){let a=this.calculateGroupBonus(e,t);e.groupScore=a,e.activationScore+=a}}return t.sort((e,n)=>(n.activationScore||0)-(e.activationScore||0))}getProb(t){let i=t?.probability??t?.useProbability??t?.prob;return(i==null||i===""||Number.isNaN(Number(i)))&&(i=100),i=Number(i),i<=1&&i>=0&&(i=i*100),i=Math.max(0,Math.min(100,i)),i}applyProbability(t){return t.filter(i=>i.stickyRemaining&&i.stickyRemaining>0?!0:this.rand()*100<=this.getProb(i))}recursiveScan(t,i,s,e){let n=[...t],a=new Set(n.map(o=>o.id)),r=1;for(;r<=(e.maxRecursionSteps??2);){let o=n.map(u=>u.content).join(`
`),c=[];for(let u of i.entries){if(a.has(u.id)||u.delayLevel&&r<u.delayLevel)continue;let f=this.matchKeys(u,o,e);f.length>0&&c.push({...u,matchedKeys:f,recursionLevel:r,score:f.length,depth:r})}if(c.length===0)break;let l=c.some(u=>u.nonRecursable||u.blockFurther),p=this.resolveInclusionGroups(c);if(p=this.applyProbability(p),n.push(...p),p.forEach(u=>a.add(u.id)),l||p.some(u=>u.blockFurther))break;r++}return n}applyBudget(t,i){let s=i.tokenBudget??2e3,e=i.contextPercent??.7,n=Math.floor(s*e),a=0,r=[];t.sort((o,c)=>(c.activationScore||0)-(o.activationScore||0));for(let o of t){let c=this.estimateTokens(o.content);if(a+c<=n)r.push(o),a+=c;else break}return r}distributeToSlots(t){let i=new Map;for(let o of t){let c=`${o.position||"after_char"}_${o.depth||0}_${o.role||"system"}`;i.has(c)||i.set(c,{position:o.position||"after_char",depth:o.depth,role:o.role,entries:[]}),i.get(c).entries.push(o)}for(let o of i.values())o.entries.sort((c,l)=>{let p=c.order??0,u=l.order??0;return p!==u?p-u:(c.id??"").localeCompare(l.id??"")});let s=o=>o==="system"?0:o==="user"?1:2,e={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},n=0,a=new Map;for(let o of i.values())a.set(o,n++);return Array.from(i.values()).sort((o,c)=>{let l=e[o.position]??5,p=e[c.position]??5;if(l!==p)return l-p;let u=o.depth??0,f=c.depth??0;if(u!==f)return u-f;let d=s(o.role)-s(c.role);return d!==0?d:a.get(o)-a.get(c)})}createActivatedEntry(t,i,s,e){return{...t,matchedKeys:i,depth:s,activationScore:this.calculateActivationScore(t,e.scanText||"",i),activationTime:Date.now()}}matchKeys(t,i,s){let e=[],n=t.caseSensitive??s?.caseSensitive??!1,a=t.matchWholeWords??s?.matchWholeWords??!1;for(let r of t.keys||[]){let o=n?i:i.toLowerCase(),c=n?r:r.toLowerCase();a?this.makeWholeWordRegex(r,n).test(i)&&e.push(r):o.includes(c)&&e.push(r)}return e}containsCJK(t){return/[\p{Script=Han}\p{Hangul}\p{Hiragana}\p{Katakana}]/u.test(t)}makeWholeWordRegex(t,i){let s=i?"u":"iu";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),s):new RegExp(`(^|[^\\p{L}\\p{N}_])${this.escapeRegex(t)}([^\\p{L}\\p{N}_]|$)`,s)}textMatch(t,i,s={}){let{caseSensitive:e=!1,wholeWords:n=!1}=s;if(i.startsWith("/")&&i.lastIndexOf("/")>0)try{let o=i.lastIndexOf("/"),c=i.slice(1,o),l=i.slice(o+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let a=e?t:t.toLowerCase(),r=e?i:i.toLowerCase();if(n){if(this.makeWholeWordRegex(r,e).test(t))return!0}else if(a.includes(r))return!0;return!1}calculateActivationScore(t,i,s){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let n of s)e+=n.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,i){return t.group?i.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let i=new Map,s=[];for(let n of t)if(n.inclusionGroup||n.group){let a=n.inclusionGroup||n.group,r=i.get(a)??[];r.push(n),i.set(a,r)}else s.push(n);let e=[];for(let[,n]of i){let a=this.selectFromGroup(n);a&&e.push(a)}return[...e,...s]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let i=t.some(r=>r.useGroupScoring),s=t.some(r=>r.prioritizeInclusion),e=t;if(i){let r=Math.max(...e.map(o=>o.score??0));e=e.filter(o=>(o.score??0)===r)}if(s)return e.reduce((r,o)=>{let c=r.priority??0,l=o.priority??0;return c!==l?l>c?o:r:(o.order??0)>(r.order??0)?o:r});let n=e.reduce((r,o)=>r+(o.groupWeight??100),0),a=this.rand()*n;for(let r of e)if(a-=r.groupWeight??100,a<=0)return r;return e[0]}minActivationScan(t,i,s,e){let n=e.minActivations??1;if(t.length>=n)return t;let a=n-t.length,r=i.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));r.sort((c,l)=>(l.priority||0)-(c.priority||0));let o=[];for(let c=0;c<Math.min(a,r.length);c++){let l=r[c];o.push(this.createActivatedEntry(l,[],0,s))}return[...t,...o]}calculateTotalTokens(t){return t.reduce((i,s)=>i+this.estimateTokens(s.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{v as a};
