var m=class{constructor(t={}){this.timedEffectsState=new Map;this.rand=Math.random;if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let n=t.seed>>>0||1;this.rand=()=>((n=1664525*n+1013904223>>>0)&4294967295)/4294967296}else this.rand=Math.random;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...t}}setOptions(t){this.settings={...this.settings,...t}}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let n of t){let i=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};n.sticky&&(i.stickyRemaining=n.sticky),n.cooldown&&(i.cooldownRemaining=n.cooldown),this.timedEffectsState.set(n.id,i)}}process(t,n){let i=performance.now();this.tickTimedEffects();let e=typeof n=="string"?{text:n,currentTime:Date.now()}:{currentTime:Date.now(),...n},r={...this.settings,...t.settings};this.settings=r;let s=this.selectCandidates(t.entries,e);s=this.applyFilters(s,e),s=this.applyTimedEffects(s,e),s=this.applyProbability(s),s=this.applyBudget(s,this.settings);let o=s.some(f=>f.blockFurther),a=!!this.settings.recursiveScan&&(this.settings.maxRecursionSteps??0)!==0;!o&&a?s=this.recursiveScan(s,t,e,this.settings):!a&&(this.settings.minActivations??0)>0&&(s=this.minActivationScan(s,t,e,this.settings)),this.commitTimedEffects(s);let u=this.distributeToSlots(s),c=performance.now();return{slots:u,activatedEntries:s,totalTokens:this.calculateTotalTokens(s),processTime:c-i}}selectCandidates(t,n){let i=[];for(let e of t){if(!e.enabled)continue;if(e.constant){i.push(this.createActivatedEntry(e,[],0,n));continue}let r=this.matchKeys(e,n.text);if(r.length>0){let s=e.minActivations??this.settings.minActivations??1;if(e.selectiveLogic){let o=e.selectiveLogic.includes("AND")?e.keys.length:1;r.length>=o&&i.push(this.createActivatedEntry(e,r,0,n))}else r.length>=s&&i.push(this.createActivatedEntry(e,r,0,n))}}return i}applyFilters(t,n){return t.filter(i=>{if(i.optionalFilter){let e=i.optionalFilter,r=i.caseSensitive??this.settings.caseSensitive??!1,s=n.text,o=r?s:s.toLowerCase(),a=e.keys.map(c=>r?c:c.toLowerCase()).map(c=>o.includes(c));if(!(e.logic==="AND_ALL"?a.every(Boolean):e.logic==="NOT_ANY"?!a.some(Boolean):e.logic==="NOT_ALL"?!a.every(Boolean):a.some(Boolean)))return!1}return!0})}applyTimedEffects(t,n){let i=[],e=n?.chatHistory?.length??0;for(let r of t){let s=this.timedEffectsState.get(r.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(r.delay&&e<r.delay||s.cooldownRemaining>0)continue;let o={...r};s.stickyRemaining>0&&(o.stickyRemaining=s.stickyRemaining),i.push(o)}return i}applyScoring(t,n){for(let i of t){let e=0;i.constant&&(e+=1e3),e+=(i.priority||0)*100,e+=(i.order||0)*10;for(let r of i.matchedKeys)e+=r.length;if(i.probability!==void 0&&(e+=i.probability*50),i.activationScore=e,this.settings.useGroupScoring&&i.group){let r=this.calculateGroupBonus(i,t);i.groupScore=r,i.activationScore+=r}}return t.sort((i,e)=>(e.activationScore||0)-(i.activationScore||0))}applyProbability(t){return t.filter(n=>{if(n.stickyRemaining&&n.stickyRemaining>0)return!0;let i=n.probability;return(i==null||Number.isNaN(i))&&(i=100),i=Math.max(0,Math.min(100,Number(i))),this.rand()*100<=i})}recursiveScan(t,n,i,e){let r=[...t],s=new Set(r.map(u=>u.id)),o=1,a=!1;for(;!a&&o<=(e.maxRecursionSteps??2);){let u=r.map(l=>l.content).join(`
`),c=[];for(let l of n.entries){if(s.has(l.id)||l.nonRecursable||l.delayLevel&&o<l.delayLevel)continue;let p=this.matchKeys(l,u);p.length>0&&c.push({...l,matchedKeys:p,recursionLevel:o,activationScore:p.length,depth:o})}if(c.length===0)break;let f=this.resolveInclusionGroups(c);f=this.applyProbability(f),r.push(...f),f.forEach(l=>s.add(l.id)),f.some(l=>l.blockFurther)&&(a=!0),o++}return r}applyBudget(t,n){let i=n.tokenBudget??2e3,e=n.contextPercent??.7,r=Math.floor(i*e),s=0,o=[];t.sort((a,u)=>(u.activationScore||0)-(a.activationScore||0));for(let a of t){let u=this.estimateTokens(a.content);if(s+u<=r)o.push(a),s+=u;else break}return o}distributeToSlots(t){let n=new Map,i={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth"};for(let c of t){let f=c.position||"after_char",l=i[f]||"after_char";n.has(l)||n.set(l,{position:l,entries:[],depth:c.depth,role:c.role}),n.get(l).entries.push(c)}let e=c=>{let f=l=>l==="system"?0:l==="user"?1:2;switch(c.position){case"before_an":return 0;case"before_char":return 1;case"before_example":return 2;case"at_depth":return 3+(c.depth??0)*.01+f(c.role)*.001;case"after_example":return 4;case"after_char":return 5;case"after_an":return 6;default:return 5}};for(let c of n.values())c.entries.sort((f,l)=>{let p=f.order??0,d=l.order??0;return p!==d?p-d:(f.id??"").localeCompare(l.id??"")});let r=c=>c==="system"?0:c==="user"?1:2,s={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},o=0,a=new Map;for(let c of n.values())a.set(c,o++);return Array.from(n.values()).sort((c,f)=>{let l=s[c.position]??5,p=s[f.position]??5;if(l!==p)return l-p;let d=c.depth??0,h=f.depth??0;if(d!==h)return d-h;let g=r(c.role)-r(f.role);return g!==0?g:a.get(c)-a.get(f)})}createActivatedEntry(t,n,i,e){return{...t,matchedKeys:n,depth:i,activationScore:this.calculateActivationScore(t,e.text,n),activationTime:e.currentTime}}matchKeys(t,n){let i=[],e=t.caseSensitive??this.settings.caseSensitive??!1,r=t.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of t.keys||[]){let o=e?n:n.toLowerCase(),a=e?s:s.toLowerCase();r?this.makeWholeWordRegex(a,e).test(n)&&i.push(s):o.includes(a)&&i.push(s)}return i}containsCJK(t){return/[\p{Script=Han}\p{Hangul}\p{Hiragana}\p{Katakana}]/u.test(t)}makeWholeWordRegex(t,n){let i=n?"u":"iu";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),i):new RegExp(`(^|[^\\p{L}\\p{N}_])${this.escapeRegex(t)}([^\\p{L}\\p{N}_]|$)`,i)}textMatch(t,n,i={}){let{caseSensitive:e=!1,wholeWords:r=!1}=i;if(n.startsWith("/")&&n.lastIndexOf("/")>0)try{let a=n.lastIndexOf("/"),u=n.slice(1,a),c=n.slice(a+1)||(e?"":"i");return new RegExp(u,c).test(t)}catch{return!1}let s=e?t:t.toLowerCase(),o=e?n:n.toLowerCase();if(r){if(this.makeWholeWordRegex(o,e).test(t))return!0}else if(s.includes(o))return!0;return!1}calculateActivationScore(t,n,i){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let r of i)e+=r.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,n){return t.group?n.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let n=new Map,i=[];for(let r of t)r.inclusionGroup?(n.get(r.inclusionGroup)??n.set(r.inclusionGroup,[]).get(r.inclusionGroup)).push(r):i.push(r);let e=[];for(let[,r]of n){let s=this.selectFromGroup(r);s&&e.push(s)}return[...e,...i]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let n=t.some(o=>o.useGroupScoring),i=t.some(o=>o.prioritizeInclusion),e=t;if(n){let o=Math.max(...e.map(a=>a.score??0));e=e.filter(a=>(a.score??0)===o)}if(i)return e.reduce((o,a)=>(a.order??0)>(o.order??0)?a:o);let r=e.reduce((o,a)=>o+(a.groupWeight??100),0),s=this.rand()*r;for(let o of e)if(s-=o.groupWeight??100,s<=0)return o;return e[0]}minActivationScan(t,n,i,e){let r=e.minActivations??1;if(t.length>=r)return t;let s=r-t.length,o=n.entries.filter(u=>u.enabled&&!t.some(c=>c.id===u.id));o.sort((u,c)=>(c.priority||0)-(u.priority||0));let a=[];for(let u=0;u<Math.min(s,o.length);u++){let c=o[u];a.push(this.createActivatedEntry(c,[],0,i))}return[...t,...a]}calculateTotalTokens(t){return t.reduce((n,i)=>n+this.estimateTokens(i.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{m as a};
