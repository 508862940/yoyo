"use strict";var WorldBookKit=(()=>{var g=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var k=(p,t)=>{for(var e in t)g(p,e,{get:t[e],enumerable:!0})},x=(p,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of A(t))!E.call(p,i)&&i!==e&&g(p,i,{get:()=>t[i],enumerable:!(r=b(t,i))||r.enumerable});return p};var _=p=>x(g({},"__esModule",{value:!0}),p);var S={};k(S,{WorldBookEngine:()=>d,WorldBookImporter:()=>h,default:()=>d});var d=class{constructor(t={}){this.activationHistory=new Map;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...t}}setOptions(t){this.settings={...this.settings,...t}}process(t,e){let r=performance.now(),i=typeof e=="string"?{text:e,currentTime:Date.now()}:{currentTime:Date.now(),...e},n={...this.settings,...t.settings};this.settings=n;let s=this.selectCandidates(t.entries,i),a=this.applyFilters(s,i),o=this.applyTimeFilters(a,i),c=this.applyScoring(o,i),l=this.applyProbabilityFilter(c,i),u=this.handleRecursion(l,t.entries,i),f=this.applyBudgetLimits(u),v=this.organizeByPosition(f),m=performance.now();return{slots:v,activatedEntries:f,totalTokens:this.calculateTotalTokens(f),processTime:m-r}}selectCandidates(t,e){let r=[];for(let i of t){if(!i.enabled)continue;if(i.constant){r.push(this.createActivatedEntry(i,[],0,e));continue}let n=this.matchKeys(i,e.text);if(n.length>0){let s=i.minActivations??this.settings.minActivations??1;if(i.selectiveLogic){let a=i.selectiveLogic.includes("AND")?i.keys.length:1;n.length>=a&&r.push(this.createActivatedEntry(i,n,0,e))}else n.length>=s&&r.push(this.createActivatedEntry(i,n,0,e))}}return r}applyFilters(t,e){return t.filter(r=>{if(r.optionalFilter){let i=r.optionalFilter,s=(i.keys||[]).map(o=>this.textMatch(e.text,o,{caseSensitive:r.caseSensitive??this.settings.caseSensitive??!1,wholeWords:!1}));if(!(i.logic==="AND_ALL"?s.every(Boolean):i.logic==="NOT_ANY"?!s.some(Boolean):i.logic==="NOT_ALL"?!s.every(Boolean):s.some(Boolean)))return!1}return!0})}applyTimeFilters(t,e){let r=e.currentTime??Date.now(),i=[];for(let n of t){let s=this.activationHistory.get(n.id);s?.cooldownUntil&&r<s.cooldownUntil||n.delay&&(!s||r-s.time<n.delay*1e3)||(n.sticky&&s?.stickyUntil&&r<s.stickyUntil&&(n.activationScore=(n.activationScore||0)+1e3),i.push(n))}return i}applyScoring(t,e){for(let r of t){let i=0;r.constant&&(i+=1e3),i+=(r.priority||0)*100,i+=(r.order||0)*10;for(let n of r.matchedKeys)i+=n.length;if(r.probability!==void 0&&(i+=r.probability*50),r.activationScore=i,this.settings.useGroupScoring&&r.group){let n=this.calculateGroupBonus(r,t);r.groupScore=n,r.activationScore+=n}}return t.sort((r,i)=>(i.activationScore||0)-(r.activationScore||0))}applyProbabilityFilter(t,e){let r=e.currentTime??Date.now();return t.filter(i=>{let n=this.activationHistory.get(i.id);return i.sticky&&n?.stickyUntil&&r<n.stickyUntil?!0:!(i.probability!==void 0&&Math.random()>i.probability)})}handleRecursion(t,e,r,i=0){if(!this.settings.recursive||i>=(this.settings.maxDepth??3))return t;let n=[...t],s=this.settings.maxRecursionSteps??10;for(let a of t)if(!(a.nonRecursable||i>=s)&&a.recursive!==!1&&a.content){let o={...r,text:a.content},c=this.selectCandidates(e,o),l=this.applyFilters(c,o);for(let u of l)u.depth=i+1,n.push(u);if(a.blockFurther)break}if(n.length===t.length&&this.settings.minActivations){let a=this.ensureMinimumActivations(e,r);n.push(...a)}return n}applyBudgetLimits(t){let e=this.settings.tokenBudget??2e3,r=this.settings.contextPercent??.7,i=Math.floor(e*r),n=0,s=[],a={},o=[];for(let c of t)c.group?(a[c.group]||(a[c.group]=[]),a[c.group].push(c)):o.push(c);for(let[c,l]of Object.entries(a))if(l.sort((u,f)=>(f.activationScore||0)-(u.activationScore||0)),l.length>0){let u=this.estimateTokens(l[0].content);n+u<=i&&(s.push(l[0]),n+=u)}for(let c of o){let l=this.estimateTokens(c.content);if(n+l<=i)s.push(c),n+=l;else break}return s}organizeByPosition(t){let e={before_char:[],after_char:[],before_example:[],after_example:[],before_an:[],after_an:[],at_depth:[]};for(let r of t){let i=r.position||"after_char";e[i]?e[i].push(r):e.after_char.push(r)}for(let r in e)e[r].sort((i,n)=>(i.order||0)-(n.order||0));return Object.entries(e).filter(([r,i])=>i.length>0).map(([r,i])=>({position:r,entries:i}))}createActivatedEntry(t,e,r,i){let n={...t,matchedKeys:e,depth:r,activationScore:this.calculateActivationScore(t,i.text,e),activationTime:i.currentTime},s=i.currentTime??Date.now(),a={time:s,stickyUntil:t.sticky?s+t.sticky*1e3:void 0,cooldownUntil:t.cooldown?s+t.cooldown*1e3:void 0};return this.activationHistory.set(t.id,a),n}matchKeys(t,e){let r=[],i=t.caseSensitive??this.settings.caseSensitive??!1,n=t.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of t.keys||[])this.textMatch(e,s,{caseSensitive:i,wholeWords:n})&&r.push(s);return r}textMatch(t,e,r={}){let{caseSensitive:i=!1,wholeWords:n=!1}=r,s=i?t:this.toHalfWidth(t).toLowerCase(),a=i?e:this.toHalfWidth(e).toLowerCase();if(a.startsWith("/")&&a.lastIndexOf("/")>0)try{let o=a.lastIndexOf("/"),c=a.slice(1,o),l=a.slice(o+1)||(i?"":"i");return new RegExp(c,l).test(t)}catch{return!1}return this.hasCJK(a)||this.hasCJK(s)?s.includes(a):n?new RegExp(`\\b${this.escapeRegex(a)}\\b`,i?"":"i").test(t):s.includes(a)}calculateActivationScore(t,e,r){let i=0;t.constant&&(i+=1e3),i+=(t.priority||0)*100,i+=(t.order||0)*10;for(let n of r)i+=n.length;return t.probability!==void 0&&(i+=t.probability*50),i}calculateGroupBonus(t,e){return t.group?e.filter(i=>i.group===t.group).length*10:0}ensureMinimumActivations(t,e){return[]}calculateTotalTokens(t){return t.reduce((e,r)=>e+this.estimateTokens(r.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}toHalfWidth(t){return t.replace(/[\uFF01-\uFF5E]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/\u3000/g," ")}hasCJK(t){return/[\u3400-\u9FFF\uF900-\uFAFF]/.test(t||"")}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var y={weather:["\u5929\u6C14","\u6C14\u5019","\u4E0B\u96E8","\u53F0\u98CE","\u6E29\u5EA6","\u9884\u62A5","\u9884\u8B66"],restaurant:["\u9910\u5385","\u7F8E\u98DF","\u5403\u996D","\u9910\u9986","\u996D\u5E97","\u5C0F\u5403"],travel:["\u65C5\u884C","\u65C5\u6E38","\u884C\u7A0B","\u51FA\u884C"],tips:["\u6CE8\u610F\u4E8B\u9879","\u8D34\u58EB","\u63D0\u793A"],safety:["\u5B89\u5168","\u98CE\u9669","\u5371\u9669","\u9884\u8B66"],attraction:["\u666F\u70B9","\u516C\u56ED","\u6D77\u6E7E","\u6C99\u6EE9","\u73A9"],shopping:["\u8D2D\u7269","\u514D\u7A0E\u5E97","\u7279\u4EA7"],food:["\u7F8E\u98DF","\u83DC","\u5C0F\u5403","\u7279\u8272"],hainan:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],haikou:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],sanya:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],yalong:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"]},h=class{static import(t){if(!t||typeof t!="object")throw new Error("Invalid worldbook data");let e={...t};return e.worldbook&&Array.isArray(e.worldbook)&&!e.entries&&(e.entries=e.worldbook,delete e.worldbook),Array.isArray(e.entries)||(e.entries=[]),e.entries=e.entries.map((r,i)=>{let n={...r},s=[],a=["keys","key","keywords","primary_keys","\u5173\u952E\u8BCD","\u89E6\u53D1\u8BCD"];for(let o of a)if(n[o]){if(typeof n[o]=="string")s.push(...n[o].split(/[,\s、，;；|\/]+/).map(c=>c.trim()).filter(c=>c.length>0));else if(Array.isArray(n[o]))s.push(...n[o]);else if(typeof n[o]=="object"&&n[o].primary){let c=Array.isArray(n[o].primary)?n[o].primary:[],l=Array.isArray(n[o].secondary)?n[o].secondary:[];s.push(...c),l.length>0&&(n.optionalFilter=n.optionalFilter||{keys:[],logic:"AND_ANY"},n.optionalFilter.keys=l)}o!=="keys"&&delete n[o]}if(n.keys=s.length>0?this.expandEnglishKeys(s):[],!n.content&&n.content!==""&&(n.entry?(n.content=n.entry,delete n.entry):n.text?(n.content=n.text,delete n.text):n.content=""),n.enabled===void 0&&(n.enabled=!0),typeof n.position=="number"){let o={0:"before_char",1:"after_char",2:"before_example",3:"after_example",4:"before_an",5:"after_an",6:"at_depth"};n.position=o[n.position]||"after_char"}else if(typeof n.position=="string"){let o={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth",top:"before_char",beforeMain:"before_an",afterMain:"after_an",afterSystem:"after_char",bottom:"after_char",floating:"after_char",unknown:"after_char"};n.position=o[n.position]||n.position}else n.position||(n.position="after_char");return!n.id&&n.id!==0&&(n.id=`entry_${i}`),n}),e}static expandEnglishKeys(t){let e=[...t];for(let r of t){let i=r.toLowerCase();y[i]&&e.push(...y[i])}return[...new Set(e.map(r=>r.replace(/[\uFF01-\uFF5E]/g,i=>String.fromCharCode(i.charCodeAt(0)-65248)).replace(/\u3000/g," ").trim()))].filter(r=>r.length>0)}static validate(t){if(!t||typeof t!="object")return{valid:!1,errors:["Worldbook must be an object"]};if(!Array.isArray(t.entries))return{valid:!1,errors:["Worldbook must have an entries array"]};let e=[];return t.entries.forEach((r,i)=>{!r.id&&r.id!==0&&e.push(`Entry at index ${i} is missing id`),Array.isArray(r.keys)||e.push(`Entry at index ${i} is missing keys array`),!r.content&&r.content!==""&&e.push(`Entry at index ${i} is missing content`)}),{valid:e.length===0,errors:e}}static export(t){return{name:t.name,description:t.description,version:t.version,entries:t.entries.map(e=>({id:e.id,name:e.name,keys:e.keys,content:e.content,enabled:e.enabled,position:e.position,priority:e.priority,order:e.order,constant:e.constant,selectiveLogic:e.selectiveLogic,caseSensitive:e.caseSensitive,matchWholeWords:e.matchWholeWords,optionalFilter:e.optionalFilter,group:e.group,probability:e.probability,recursive:e.recursive,sticky:e.sticky,cooldown:e.cooldown,delay:e.delay,nonRecursable:e.nonRecursable,blockFurther:e.blockFurther,delayLevel:e.delayLevel,maxRecursionSteps:e.maxRecursionSteps})),settings:t.settings,metadata:t.metadata}}};return _(S);})();
