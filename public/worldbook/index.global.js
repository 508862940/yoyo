"use strict";var WorldBookKit=(()=>{var y=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var S=Object.prototype.hasOwnProperty;var k=(p,e)=>{for(var t in e)y(p,t,{get:e[t],enumerable:!0})},x=(p,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of _(e))!S.call(p,i)&&i!==t&&y(p,i,{get:()=>e[i],enumerable:!(r=A(e,i))||r.enumerable});return p};var R=p=>x(y({},"__esModule",{value:!0}),p);var w={};k(w,{WorldBookEngine:()=>g,WorldBookImporter:()=>m,default:()=>g});var g=class{constructor(e={}){this.timedEffectsState=new Map;this.rand=Math.random;if(e?.random)this.rand=e.random;else if(typeof e?.seed=="number"){let t=e.seed>>>0||1;this.rand=()=>((t=1664525*t+1013904223>>>0)&4294967295)/4294967296}else this.rand=Math.random;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...e}}setOptions(e){this.settings={...this.settings,...e}}tickTimedEffects(){for(let e of this.timedEffectsState.values())e.stickyRemaining>0&&e.stickyRemaining--,e.cooldownRemaining>0&&e.cooldownRemaining--}commitTimedEffects(e){for(let t of e){let r=this.timedEffectsState.get(t.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};t.sticky&&(r.stickyRemaining=t.sticky),t.cooldown&&(r.cooldownRemaining=t.cooldown),this.timedEffectsState.set(t.id,r)}}process(e,t){let r=performance.now();this.tickTimedEffects();let i=typeof t=="string"?{text:t,currentTime:Date.now()}:{currentTime:Date.now(),...t},n={...this.settings,...e.settings};this.settings=n;let s=this.selectCandidates(e.entries,i);s=this.applyFilters(s,i),s=this.applyTimedEffects(s,i),s=this.applyProbability(s),s=this.applyBudget(s,this.settings);let a=s.some(u=>u.blockFurther),o=!!this.settings.recursiveScan&&(this.settings.maxRecursionSteps??0)!==0;!a&&o?s=this.recursiveScan(s,e,i,this.settings):!o&&(this.settings.minActivations??0)>0&&(s=this.minActivationScan(s,e,i,this.settings)),this.commitTimedEffects(s);let l=this.distributeToSlots(s),c=performance.now();return{slots:l,activatedEntries:s,totalTokens:this.calculateTotalTokens(s),processTime:c-r}}selectCandidates(e,t){let r=[];for(let i of e){if(!i.enabled)continue;if(i.constant){r.push(this.createActivatedEntry(i,[],0,t));continue}let n=this.matchKeys(i,t.text);if(n.length>0){let s=i.minActivations??this.settings.minActivations??1;if(i.selectiveLogic){let a=i.selectiveLogic.includes("AND")?i.keys.length:1;n.length>=a&&r.push(this.createActivatedEntry(i,n,0,t))}else n.length>=s&&r.push(this.createActivatedEntry(i,n,0,t))}}return r}applyFilters(e,t){return e.filter(r=>{if(r.optionalFilter){let i=r.optionalFilter,n=r.caseSensitive??this.settings.caseSensitive??!1,s=t.text,a=n?s:s.toLowerCase(),o=i.keys.map(c=>n?c:c.toLowerCase()).map(c=>a.includes(c));if(!(i.logic==="AND_ALL"?o.every(Boolean):i.logic==="NOT_ANY"?!o.some(Boolean):i.logic==="NOT_ALL"?!o.every(Boolean):o.some(Boolean)))return!1}return!0})}applyTimedEffects(e,t){let r=[],i=t?.chatHistory?.length??0;for(let n of e){let s=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(n.delay&&i<n.delay||s.cooldownRemaining>0)continue;let a={...n};s.stickyRemaining>0&&(a.stickyRemaining=s.stickyRemaining),r.push(a)}return r}applyScoring(e,t){for(let r of e){let i=0;r.constant&&(i+=1e3),i+=(r.priority||0)*100,i+=(r.order||0)*10;for(let n of r.matchedKeys)i+=n.length;if(r.probability!==void 0&&(i+=r.probability*50),r.activationScore=i,this.settings.useGroupScoring&&r.group){let n=this.calculateGroupBonus(r,e);r.groupScore=n,r.activationScore+=n}}return e.sort((r,i)=>(i.activationScore||0)-(r.activationScore||0))}applyProbability(e){return e.filter(t=>{if(t.stickyRemaining&&t.stickyRemaining>0)return!0;let r=t.probability;return(r==null||Number.isNaN(r))&&(r=100),r=Math.max(0,Math.min(100,Number(r))),this.rand()*100<=r})}recursiveScan(e,t,r,i){let n=[...e],s=new Set(n.map(l=>l.id)),a=1,o=!1;for(;!o&&a<=(i.maxRecursionSteps??2);){let l=n.map(f=>f.content).join(`
`),c=[];for(let f of t.entries){if(s.has(f.id)||f.nonRecursable||f.delayLevel&&a<f.delayLevel)continue;let d=this.matchKeys(f,l);d.length>0&&c.push({...f,matchedKeys:d,recursionLevel:a,activationScore:d.length,depth:a})}if(c.length===0)break;let u=this.resolveInclusionGroups(c);u=this.applyProbability(u),n.push(...u),u.forEach(f=>s.add(f.id)),u.some(f=>f.blockFurther)&&(o=!0),a++}return n}applyBudget(e,t){let r=t.tokenBudget??2e3,i=t.contextPercent??.7,n=Math.floor(r*i),s=0,a=[];e.sort((o,l)=>(l.activationScore||0)-(o.activationScore||0));for(let o of e){let l=this.estimateTokens(o.content);if(s+l<=n)a.push(o),s+=l;else break}return a}distributeToSlots(e){let t=new Map,r={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth"};for(let c of e){let u=c.position||"after_char",f=r[u]||"after_char";t.has(f)||t.set(f,{position:f,entries:[],depth:c.depth,role:c.role}),t.get(f).entries.push(c)}let i=c=>{let u=f=>f==="system"?0:f==="user"?1:2;switch(c.position){case"before_an":return 0;case"before_char":return 1;case"before_example":return 2;case"at_depth":return 3+(c.depth??0)*.01+u(c.role)*.001;case"after_example":return 4;case"after_char":return 5;case"after_an":return 6;default:return 5}};for(let c of t.values())c.entries.sort((u,f)=>{let d=u.order??0,h=f.order??0;return d!==h?d-h:(u.id??"").localeCompare(f.id??"")});let n=c=>c==="system"?0:c==="user"?1:2,s={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},a=0,o=new Map;for(let c of t.values())o.set(c,a++);return Array.from(t.values()).sort((c,u)=>{let f=s[c.position]??5,d=s[u.position]??5;if(f!==d)return f-d;let h=c.depth??0,v=u.depth??0;if(h!==v)return h-v;let b=n(c.role)-n(u.role);return b!==0?b:o.get(c)-o.get(u)})}createActivatedEntry(e,t,r,i){return{...e,matchedKeys:t,depth:r,activationScore:this.calculateActivationScore(e,i.text,t),activationTime:i.currentTime}}matchKeys(e,t){let r=[],i=e.caseSensitive??this.settings.caseSensitive??!1,n=e.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of e.keys||[]){let a=i?t:t.toLowerCase(),o=i?s:s.toLowerCase();n?this.makeWholeWordRegex(o,i).test(t)&&r.push(s):a.includes(o)&&r.push(s)}return r}containsCJK(e){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(e)}makeWholeWordRegex(e,t){let r=t?"g":"gi";return this.containsCJK(e)?new RegExp(this.escapeRegex(e),r):new RegExp(`(^|\\W)${this.escapeRegex(e)}(\\W|$)`,r)}textMatch(e,t,r={}){let{caseSensitive:i=!1,wholeWords:n=!1}=r;if(t.startsWith("/")&&t.lastIndexOf("/")>0)try{let o=t.lastIndexOf("/"),l=t.slice(1,o),c=t.slice(o+1)||(i?"":"i");return new RegExp(l,c).test(e)}catch{return!1}let s=i?e:e.toLowerCase(),a=i?t:t.toLowerCase();if(n){if(this.makeWholeWordRegex(a,i).test(e))return!0}else if(s.includes(a))return!0;return!1}calculateActivationScore(e,t,r){let i=0;e.constant&&(i+=1e3),i+=(e.priority||0)*100,i+=(e.order||0)*10;for(let n of r)i+=n.length;return e.probability!==void 0&&(i+=e.probability*50),i}calculateGroupBonus(e,t){return e.group?t.filter(i=>i.group===e.group).length*10:0}resolveInclusionGroups(e){let t=new Map,r=[];for(let n of e)n.inclusionGroup?(t.get(n.inclusionGroup)??t.set(n.inclusionGroup,[]).get(n.inclusionGroup)).push(n):r.push(n);let i=[];for(let[,n]of t){let s=this.selectFromGroup(n);s&&i.push(s)}return[...i,...r]}selectFromGroup(e){if(!e.length)return null;if(e.length===1)return e[0];let t=e.some(a=>a.useGroupScoring),r=e.some(a=>a.prioritizeInclusion),i=e;if(t){let a=Math.max(...i.map(o=>o.score??0));i=i.filter(o=>(o.score??0)===a)}if(r)return i.reduce((a,o)=>(o.order??0)>(a.order??0)?o:a);let n=i.reduce((a,o)=>a+(o.groupWeight??100),0),s=this.rand()*n;for(let a of i)if(s-=a.groupWeight??100,s<=0)return a;return i[0]}minActivationScan(e,t,r,i){let n=i.minActivations??1;if(e.length>=n)return e;let s=n-e.length,a=t.entries.filter(l=>l.enabled&&!e.some(c=>c.id===l.id));a.sort((l,c)=>(c.priority||0)-(l.priority||0));let o=[];for(let l=0;l<Math.min(s,a.length);l++){let c=a[l];o.push(this.createActivatedEntry(c,[],0,r))}return[...e,...o]}calculateTotalTokens(e){return e.reduce((t,r)=>t+this.estimateTokens(r.content),0)}estimateTokens(e){return Math.ceil(e.length/4)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var E={weather:["\u5929\u6C14","\u6C14\u5019","\u4E0B\u96E8","\u53F0\u98CE","\u6E29\u5EA6","\u9884\u62A5","\u9884\u8B66"],restaurant:["\u9910\u5385","\u7F8E\u98DF","\u5403\u996D","\u9910\u9986","\u996D\u5E97","\u5C0F\u5403"],travel:["\u65C5\u884C","\u65C5\u6E38","\u884C\u7A0B","\u51FA\u884C"],tips:["\u6CE8\u610F\u4E8B\u9879","\u8D34\u58EB","\u63D0\u793A"],safety:["\u5B89\u5168","\u98CE\u9669","\u5371\u9669","\u9884\u8B66"],attraction:["\u666F\u70B9","\u516C\u56ED","\u6D77\u6E7E","\u6C99\u6EE9","\u73A9"],shopping:["\u8D2D\u7269","\u514D\u7A0E\u5E97","\u7279\u4EA7"],food:["\u7F8E\u98DF","\u83DC","\u5C0F\u5403","\u7279\u8272"],hainan:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],haikou:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],sanya:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],yalong:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"]},m=class{static import(e){if(!e||typeof e!="object")throw new Error("Invalid worldbook data");let t={...e};return t.worldbook&&Array.isArray(t.worldbook)&&!t.entries&&(t.entries=t.worldbook,delete t.worldbook),Array.isArray(t.entries)||(t.entries=[]),t.entries=t.entries.map((r,i)=>{let n={...r},s=[],a=["keys","key","keywords","primary_keys","\u5173\u952E\u8BCD","\u89E6\u53D1\u8BCD"];for(let o of a)if(n[o]){if(typeof n[o]=="string")s.push(...n[o].split(/[,\s、，;；|\/]+/).map(l=>l.trim()).filter(l=>l.length>0));else if(Array.isArray(n[o]))s.push(...n[o]);else if(typeof n[o]=="object"&&n[o].primary){let l=Array.isArray(n[o].primary)?n[o].primary:[],c=Array.isArray(n[o].secondary)?n[o].secondary:[];s.push(...l),c.length>0&&(n.optionalFilter=n.optionalFilter||{keys:[],logic:"AND_ANY"},n.optionalFilter.keys=c)}o!=="keys"&&delete n[o]}if(n.keys=s.length>0?this.expandEnglishKeys(s):[],!n.content&&n.content!==""&&(n.entry?(n.content=n.entry,delete n.entry):n.text?(n.content=n.text,delete n.text):n.content=""),n.enabled===void 0&&(n.enabled=!0),typeof n.position=="number"){let o={0:"before_char",1:"after_char",2:"before_example",3:"after_example",4:"before_an",5:"after_an",6:"at_depth"};n.position=o[n.position]||"after_char"}else if(typeof n.position=="string"){let o={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth",top:"before_char",beforeMain:"before_an",afterMain:"after_an",afterSystem:"after_char",bottom:"after_char",floating:"after_char",unknown:"after_char"};n.position=o[n.position]||n.position}else n.position||(n.position="after_char");return!n.id&&n.id!==0&&(n.id=`entry_${i}`),n}),t}static expandEnglishKeys(e){let t=[...e];for(let r of e){let i=r.toLowerCase();E[i]&&t.push(...E[i])}return[...new Set(t.map(r=>r.replace(/[\uFF01-\uFF5E]/g,i=>String.fromCharCode(i.charCodeAt(0)-65248)).replace(/\u3000/g," ").trim()))].filter(r=>r.length>0)}static validate(e){if(!e||typeof e!="object")return{valid:!1,errors:["Worldbook must be an object"]};if(!Array.isArray(e.entries))return{valid:!1,errors:["Worldbook must have an entries array"]};let t=[];return e.entries.forEach((r,i)=>{!r.id&&r.id!==0&&t.push(`Entry at index ${i} is missing id`),Array.isArray(r.keys)||t.push(`Entry at index ${i} is missing keys array`),!r.content&&r.content!==""&&t.push(`Entry at index ${i} is missing content`)}),{valid:t.length===0,errors:t}}static export(e){return{name:e.name,description:e.description,version:e.version,entries:e.entries.map(t=>({id:t.id,name:t.name,keys:t.keys,content:t.content,enabled:t.enabled,position:t.position,priority:t.priority,order:t.order,constant:t.constant,selectiveLogic:t.selectiveLogic,caseSensitive:t.caseSensitive,matchWholeWords:t.matchWholeWords,optionalFilter:t.optionalFilter,group:t.group,probability:t.probability,recursive:t.recursive,sticky:t.sticky,cooldown:t.cooldown,delay:t.delay,nonRecursable:t.nonRecursable,blockFurther:t.blockFurther,delayLevel:t.delayLevel,maxRecursionSteps:t.maxRecursionSteps})),settings:e.settings,metadata:e.metadata}}};return R(w);})();
