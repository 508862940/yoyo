"use strict";var WorldBookKit=(()=>{var m=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var S=(p,e)=>{for(var t in e)m(p,t,{get:e[t],enumerable:!0})},k=(p,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of b(e))!E.call(p,i)&&i!==t&&m(p,i,{get:()=>e[i],enumerable:!(o=A(e,i))||o.enumerable});return p};var x=p=>k(m({},"__esModule",{value:!0}),p);var _={};S(_,{WorldBookEngine:()=>h,WorldBookImporter:()=>g,default:()=>h});var h=class{constructor(e){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(e?.random)this.rand=e.random;else if(typeof e?.seed=="number"){let t=e.seed>>>0||1;this.rand=()=>((t=1664525*t+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(e){this.runtimeOptions={...this.runtimeOptions,...e}}process(e,t){let o={...this.getDefaultSettings(),...e.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(o.recursiveScan=!!this.runtimeOptions.recursive);let i=this.activate({...e,settings:o},{scanText:t,chatHistory:[],generationType:"Normal"}),n=i.flatMap(r=>r.entries),a=n.map(r=>r.content).join(`
`),s=this.calculateTotalTokens(n);return{activatedEntries:n,slots:i,finalPrompt:a,totalTokens:s}}activate(e,t){this.tickTimedEffects();let o=e.settings||this.getDefaultSettings(),i=this.selectCandidates(e.entries,t,o);i=this.applyFilters(i,t,o),i=this.applyTimedEffects(i,o),i=this.applyProbability(i),i=this.resolveInclusionGroups(i),i=this.applyScoring(i,t,o),i=this.applyBudget(i,o);let n=i.some(s=>s.nonRecursable||s.blockFurther);this.commitTimedEffects(i);let a=!!o.recursiveScan&&(o.maxRecursionSteps??0)>0;return!n&&a?i=this.recursiveScan(i,e,t,o):!a&&(o.minActivations??0)>0&&(i=this.minActivationScan(i,e,t,o)),this.distributeToSlots(i)}selectCandidates(e,t,o){let i=[],n=t.scanText||"";for(let a of e){if(!a.enabled)continue;if(a.constant){i.push(this.createActivatedEntry(a,[],0,t));continue}let s=this.matchKeys(a,n,o);if(s.length>0){let r=a.minActivations??o.minActivations??1;if(a.selectiveLogic){let c=a.selectiveLogic.includes("AND")?a.keys.length:1;s.length>=c&&i.push(this.createActivatedEntry(a,s,0,t))}else s.length>=r&&i.push(this.createActivatedEntry(a,s,0,t))}}return i}applyFilters(e,t,o){return e.filter(i=>{if(i.optionalFilter){let n=i.optionalFilter,a=i.caseSensitive??o.caseSensitive??!1,s=t.scanText||"",r=a?s:s.toLowerCase(),c=n.keys.map(u=>a?u:u.toLowerCase()).map(u=>r.includes(u));if(!(n.logic==="AND_ALL"?c.every(Boolean):n.logic==="NOT_ANY"?!c.some(Boolean):n.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let e of this.timedEffectsState.values())e.stickyRemaining>0&&e.stickyRemaining--,e.cooldownRemaining>0&&e.cooldownRemaining--}commitTimedEffects(e){for(let t of e){let o=this.timedEffectsState.get(t.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};t.sticky&&(o.stickyRemaining=t.sticky),t.cooldown&&(o.cooldownRemaining=t.cooldown),this.timedEffectsState.set(t.id,o)}}applyTimedEffects(e,t){let o=[],i=t?.chatHistory?.length??0;for(let n of e){let a=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(n.delay&&i<n.delay||a.cooldownRemaining>0)continue;let s={...n};a.stickyRemaining>0&&(s.stickyRemaining=a.stickyRemaining),o.push(s)}return o}applyScoring(e,t,o){for(let i of e){let n=0;i.constant&&(n+=1e3),n+=(i.priority||0)*100,n+=(i.order||0)*10;for(let a of i.matchedKeys)n+=a.length;if(i.probability!==void 0&&(n+=i.probability*50),i.activationScore=n,i.score=n,o.useGroupScoring&&i.group){let a=this.calculateGroupBonus(i,e);i.groupScore=a,i.activationScore+=a}}return e.sort((i,n)=>(n.activationScore||0)-(i.activationScore||0))}getProb(e){let t=e?.probability??e?.useProbability??e?.prob;return(t==null||t===""||Number.isNaN(Number(t)))&&(t=100),t=Number(t),t<=1&&t>=0&&(t=t*100),t=Math.max(0,Math.min(100,t)),t}applyProbability(e){return e.filter(t=>t.stickyRemaining&&t.stickyRemaining>0?!0:this.rand()*100<=this.getProb(t))}recursiveScan(e,t,o,i){let n=[...e],a=new Set(n.map(r=>r.id)),s=1;for(;s<=(i.maxRecursionSteps??2);){let r=n.map(f=>f.content).join(`
`),c=[];for(let f of t.entries){if(a.has(f.id)||f.delayLevel&&s<f.delayLevel)continue;let d=this.matchKeys(f,r,i);d.length>0&&c.push({...f,matchedKeys:d,recursionLevel:s,score:d.length,depth:s,activationScore:d.length})}if(c.length===0)break;let l=c.some(f=>f.nonRecursable||f.blockFurther),u=this.resolveInclusionGroups(c);if(u=this.applyProbability(u),n.push(...u),u.forEach(f=>a.add(f.id)),l||u.some(f=>f.blockFurther))break;s++}return n}applyBudget(e,t){let o=t.tokenBudget??2e3,i=t.contextPercent??.7,n=Math.floor(o*i),a=0,s=[];e.sort((r,c)=>(c.activationScore||0)-(r.activationScore||0));for(let r of e){let c=this.estimateTokens(r.content);if(a+c<=n)s.push(r),a+=c;else break}return s}distributeToSlots(e){let t=new Map;for(let r of e){let c=`${r.position||"after_char"}_${r.depth||0}_${r.role||"system"}`;t.has(c)||t.set(c,{position:r.position||"after_char",depth:r.depth,role:r.role,entries:[]}),t.get(c).entries.push(r)}for(let r of t.values())r.entries.sort((c,l)=>{let u=c.order??0,f=l.order??0;return u!==f?u-f:(c.id??"").localeCompare(l.id??"")});let o=r=>r==="system"?0:r==="user"?1:2,i={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},n=0,a=new Map;for(let r of t.values())a.set(r,n++);return Array.from(t.values()).sort((r,c)=>{let l=i[r.position]??5,u=i[c.position]??5;if(l!==u)return l-u;let f=r.depth??0,d=c.depth??0;if(f!==d)return f-d;let v=o(r.role)-o(c.role);return v!==0?v:a.get(r)-a.get(c)})}createActivatedEntry(e,t,o,i){return{...e,matchedKeys:t,depth:o,activationScore:this.calculateActivationScore(e,i.scanText||"",t),activationTime:Date.now()}}matchKeys(e,t,o){let i=[],n=e.caseSensitive??o?.caseSensitive??!1,a=e.matchWholeWords??o?.matchWholeWords??!1;for(let s of e.keys||[]){let r=n?t:t.toLowerCase(),c=n?s:s.toLowerCase();a?this.makeWholeWordRegex(s,n).test(t)&&i.push(s):r.includes(c)&&i.push(s)}return i}containsCJK(e){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(e)}makeWholeWordRegex(e,t){let o=t?"g":"gi";return this.containsCJK(e)?new RegExp(this.escapeRegex(e),o):new RegExp(`(^|\\W)${this.escapeRegex(e)}(\\W|$)`,o)}textMatch(e,t,o={}){let{caseSensitive:i=!1,wholeWords:n=!1}=o;if(t.startsWith("/")&&t.lastIndexOf("/")>0)try{let r=t.lastIndexOf("/"),c=t.slice(1,r),l=t.slice(r+1)||(i?"":"i");return new RegExp(c,l).test(e)}catch{return!1}let a=i?e:e.toLowerCase(),s=i?t:t.toLowerCase();if(n){if(this.makeWholeWordRegex(s,i).test(e))return!0}else if(a.includes(s))return!0;return!1}calculateActivationScore(e,t,o){let i=0;e.constant&&(i+=1e3),i+=(e.priority||0)*100,i+=(e.order||0)*10;for(let n of o)i+=n.length;return e.probability!==void 0&&(i+=e.probability*50),i}calculateGroupBonus(e,t){return e.group?t.filter(i=>i.group===e.group).length*10:0}resolveInclusionGroups(e){let t=new Map,o=[];for(let n of e){let a=n.inclusionGroup||n.group;if(a){let s=t.get(a)??[];s.push(n),t.set(a,s)}else o.push(n)}let i=[];for(let[,n]of t){let a=this.selectFromGroup(n);a&&i.push(a)}return[...i,...o]}selectFromGroup(e){if(!e.length)return null;if(e.length===1)return e[0];let t=e.some(s=>s.useGroupScoring),o=e.some(s=>s.prioritizeInclusion),i=e;if(t){let s=Math.max(...i.map(r=>r.score??0));i=i.filter(r=>(r.score??0)===s)}if(o)return i.reduce((s,r)=>{let c=s.priority??0,l=r.priority??0;return c!==l?l>c?r:s:(r.order??0)>(s.order??0)?r:s});let n=i.reduce((s,r)=>s+(r.groupWeight??100),0),a=this.rand()*n;for(let s of i)if(a-=s.groupWeight??100,a<=0)return s;return i[0]}minActivationScan(e,t,o,i){let n=i.minActivations??1;if(e.length>=n)return e;let a=n-e.length,s=t.entries.filter(c=>c.enabled&&!e.some(l=>l.id===c.id));s.sort((c,l)=>(l.priority||0)-(c.priority||0));let r=[];for(let c=0;c<Math.min(a,s.length);c++){let l=s[c];r.push(this.createActivatedEntry(l,[],0,o))}return[...e,...r]}calculateTotalTokens(e){return e.reduce((t,o)=>t+this.estimateTokens(o.content),0)}estimateTokens(e){return Math.ceil(e.length/4)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var y={weather:["\u5929\u6C14","\u6C14\u5019","\u4E0B\u96E8","\u53F0\u98CE","\u6E29\u5EA6","\u9884\u62A5","\u9884\u8B66"],restaurant:["\u9910\u5385","\u7F8E\u98DF","\u5403\u996D","\u9910\u9986","\u996D\u5E97","\u5C0F\u5403"],travel:["\u65C5\u884C","\u65C5\u6E38","\u884C\u7A0B","\u51FA\u884C"],tips:["\u6CE8\u610F\u4E8B\u9879","\u8D34\u58EB","\u63D0\u793A"],safety:["\u5B89\u5168","\u98CE\u9669","\u5371\u9669","\u9884\u8B66"],attraction:["\u666F\u70B9","\u516C\u56ED","\u6D77\u6E7E","\u6C99\u6EE9","\u73A9"],shopping:["\u8D2D\u7269","\u514D\u7A0E\u5E97","\u7279\u4EA7"],food:["\u7F8E\u98DF","\u83DC","\u5C0F\u5403","\u7279\u8272"],hainan:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],haikou:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],sanya:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],yalong:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"]},g=class{static import(e){if(!e||typeof e!="object")throw new Error("Invalid worldbook data");let t={...e};return t.worldbook&&Array.isArray(t.worldbook)&&!t.entries&&(t.entries=t.worldbook,delete t.worldbook),Array.isArray(t.entries)||(t.entries=[]),t.entries=t.entries.map((o,i)=>{let n={...o},a=[],s=["keys","key","keywords","primary_keys","\u5173\u952E\u8BCD","\u89E6\u53D1\u8BCD"];for(let r of s)if(n[r]){if(typeof n[r]=="string")a.push(...n[r].split(/[,\s、，;；|\/]+/).map(c=>c.trim()).filter(c=>c.length>0));else if(Array.isArray(n[r]))a.push(...n[r]);else if(typeof n[r]=="object"&&n[r].primary){let c=Array.isArray(n[r].primary)?n[r].primary:[],l=Array.isArray(n[r].secondary)?n[r].secondary:[];a.push(...c),l.length>0&&(n.optionalFilter=n.optionalFilter||{keys:[],logic:"AND_ANY"},n.optionalFilter.keys=l)}r!=="keys"&&delete n[r]}if(n.keys=a.length>0?this.expandEnglishKeys(a):[],!n.content&&n.content!==""&&(n.entry?(n.content=n.entry,delete n.entry):n.text?(n.content=n.text,delete n.text):n.content=""),n.enabled===void 0&&(n.enabled=!0),typeof n.position=="number"){let r={0:"before_char",1:"after_char",2:"before_example",3:"after_example",4:"before_an",5:"after_an",6:"at_depth"};n.position=r[n.position]||"after_char"}else if(typeof n.position=="string"){let r={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth",top:"before_char",beforeMain:"before_an",afterMain:"after_an",afterSystem:"after_char",bottom:"after_char",floating:"after_char",unknown:"after_char"};n.position=r[n.position]||n.position}else n.position||(n.position="after_char");return!n.id&&n.id!==0&&(n.id=`entry_${i}`),n}),t}static expandEnglishKeys(e){let t=[...e];for(let o of e){let i=o.toLowerCase();y[i]&&t.push(...y[i])}return[...new Set(t.map(o=>o.replace(/[\uFF01-\uFF5E]/g,i=>String.fromCharCode(i.charCodeAt(0)-65248)).replace(/\u3000/g," ").trim()))].filter(o=>o.length>0)}static validate(e){if(!e||typeof e!="object")return{valid:!1,errors:["Worldbook must be an object"]};if(!Array.isArray(e.entries))return{valid:!1,errors:["Worldbook must have an entries array"]};let t=[];return e.entries.forEach((o,i)=>{!o.id&&o.id!==0&&t.push(`Entry at index ${i} is missing id`),Array.isArray(o.keys)||t.push(`Entry at index ${i} is missing keys array`),!o.content&&o.content!==""&&t.push(`Entry at index ${i} is missing content`)}),{valid:t.length===0,errors:t}}static export(e){return{name:e.name,description:e.description,version:e.version,entries:e.entries.map(t=>({id:t.id,name:t.name,keys:t.keys,content:t.content,enabled:t.enabled,position:t.position,priority:t.priority,order:t.order,constant:t.constant,selectiveLogic:t.selectiveLogic,caseSensitive:t.caseSensitive,matchWholeWords:t.matchWholeWords,optionalFilter:t.optionalFilter,group:t.group,probability:t.probability,recursive:t.recursive,sticky:t.sticky,cooldown:t.cooldown,delay:t.delay,nonRecursable:t.nonRecursable,blockFurther:t.blockFurther,delayLevel:t.delayLevel,maxRecursionSteps:t.maxRecursionSteps})),settings:e.settings,metadata:e.metadata}}};return x(_);})();
