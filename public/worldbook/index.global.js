"use strict";var WorldBookKit=(()=>{var m=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var E=Object.getOwnPropertyNames;var b=Object.prototype.hasOwnProperty;var A=(p,e)=>{for(var t in e)m(p,t,{get:e[t],enumerable:!0})},S=(p,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of E(e))!b.call(p,n)&&n!==t&&m(p,n,{get:()=>e[n],enumerable:!(r=y(e,n))||r.enumerable});return p};var _=p=>S(m({},"__esModule",{value:!0}),p);var x={};A(x,{WorldBookEngine:()=>d,WorldBookImporter:()=>h,default:()=>d});var d=class{constructor(e={}){this.timedEffectsState=new Map;this.rand=Math.random;if(e?.random)this.rand=e.random;else if(typeof e?.seed=="number"){let t=e.seed>>>0||1;this.rand=()=>((t=1664525*t+1013904223>>>0)&4294967295)/4294967296}else this.rand=Math.random;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...e}}setOptions(e){this.settings={...this.settings,...e}}tickTimedEffects(){for(let e of this.timedEffectsState.values())e.stickyRemaining>0&&e.stickyRemaining--,e.cooldownRemaining>0&&e.cooldownRemaining--}commitTimedEffects(e){for(let t of e){let r=this.timedEffectsState.get(t.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};t.sticky&&(r.stickyRemaining=t.sticky),t.cooldown&&(r.cooldownRemaining=t.cooldown),this.timedEffectsState.set(t.id,r)}}process(e,t){let r=performance.now();this.tickTimedEffects();let n=typeof t=="string"?{text:t,currentTime:Date.now()}:{currentTime:Date.now(),...t},i={...this.settings,...e.settings};this.settings=i;let s=this.selectCandidates(e.entries,n);s=this.applyFilters(s,n),s=this.applyTimedEffects(s,n),s=this.applyProbability(s),!!this.settings.recursiveScan&&(this.settings.maxRecursionSteps??0)!==0?s=this.recursiveScan(s,e,n,this.settings):(this.settings.minActivations??0)>0&&(s=this.minActivationScan(s,e,n,this.settings)),s=this.applyBudget(s,this.settings),this.commitTimedEffects(s);let o=this.distributeToSlots(s),c=performance.now();return{slots:o,activatedEntries:s,totalTokens:this.calculateTotalTokens(s),processTime:c-r}}selectCandidates(e,t){let r=[];for(let n of e){if(!n.enabled)continue;if(n.constant){r.push(this.createActivatedEntry(n,[],0,t));continue}let i=this.matchKeys(n,t.text);if(i.length>0){let s=n.minActivations??this.settings.minActivations??1;if(n.selectiveLogic){let a=n.selectiveLogic.includes("AND")?n.keys.length:1;i.length>=a&&r.push(this.createActivatedEntry(n,i,0,t))}else i.length>=s&&r.push(this.createActivatedEntry(n,i,0,t))}}return r}applyFilters(e,t){return e.filter(r=>{if(r.optionalFilter){let n=r.optionalFilter,i=r.caseSensitive??this.settings.caseSensitive??!1,s=t.text,a=i?s:s.toLowerCase(),o=n.keys.map(l=>i?l:l.toLowerCase()).map(l=>a.includes(l));if(!(n.logic==="AND_ALL"?o.every(Boolean):n.logic==="NOT_ANY"?!o.some(Boolean):n.logic==="NOT_ALL"?!o.every(Boolean):o.some(Boolean)))return!1}return!0})}applyTimedEffects(e,t){let r=[],n=t?.chatHistory?.length??0;for(let i of e){let s=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(i.delay&&n<i.delay||s.cooldownRemaining>0)continue;let a={...i};s.stickyRemaining>0&&(a.stickyRemaining=s.stickyRemaining),r.push(a)}return r}applyScoring(e,t){for(let r of e){let n=0;r.constant&&(n+=1e3),n+=(r.priority||0)*100,n+=(r.order||0)*10;for(let i of r.matchedKeys)n+=i.length;if(r.probability!==void 0&&(n+=r.probability*50),r.activationScore=n,this.settings.useGroupScoring&&r.group){let i=this.calculateGroupBonus(r,e);r.groupScore=i,r.activationScore+=i}}return e.sort((r,n)=>(n.activationScore||0)-(r.activationScore||0))}applyProbability(e){return e.filter(t=>t.stickyRemaining&&t.stickyRemaining>0?!0:this.rand()<(t.probability??100)/100)}recursiveScan(e,t,r,n){let i=[...e],s=new Set(i.map(c=>c.id)),a=1,o=!1;for(;!o&&a<=(n.maxRecursionSteps??2);){let c=i.map(f=>f.content).join(`
`),l=[];for(let f of t.entries){if(s.has(f.id)||f.nonRecursable||f.delayLevel&&a<f.delayLevel)continue;let g=this.matchKeys(f,c);g.length>0&&l.push({...f,matchedKeys:g,recursionLevel:a,activationScore:g.length,depth:a})}if(l.length===0)break;let u=this.resolveInclusionGroups(l);u=this.applyProbability(u),i.push(...u),u.forEach(f=>s.add(f.id)),u.some(f=>f.blockFurther)&&(o=!0),a++}return i}applyBudget(e,t){let r=t.tokenBudget??2e3,n=t.contextPercent??.7,i=Math.floor(r*n),s=0,a=[];e.sort((o,c)=>(c.activationScore||0)-(o.activationScore||0));for(let o of e){let c=this.estimateTokens(o.content);if(s+c<=i)a.push(o),s+=c;else break}return a}distributeToSlots(e){let t=new Map,r={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth"};for(let s of e){let a=s.position||"after_char",o=r[a]||"after_char";t.has(o)||t.set(o,{position:o,entries:[],depth:s.depth,role:s.role}),t.get(o).entries.push(s)}let n=s=>{let a=o=>o==="system"?0:o==="user"?1:2;switch(s.position){case"before_an":return 0;case"before_char":return 1;case"before_example":return 2;case"at_depth":return 3+(s.depth??0)*.01+a(s.role)*.001;case"after_example":return 4;case"after_char":return 5;case"after_an":return 6;default:return 5}};for(let s of t.values())s.entries.sort((a,o)=>(a.order||0)-(o.order||0));return Array.from(t.values()).sort((s,a)=>n(s)-n(a))}createActivatedEntry(e,t,r,n){return{...e,matchedKeys:t,depth:r,activationScore:this.calculateActivationScore(e,n.text,t),activationTime:n.currentTime}}matchKeys(e,t){let r=[],n=e.caseSensitive??this.settings.caseSensitive??!1,i=e.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of e.keys||[]){let a=n?t:t.toLowerCase(),o=n?s:s.toLowerCase();i?this.makeWholeWordRegex(o,n).test(t)&&r.push(s):a.includes(o)&&r.push(s)}return r}containsCJK(e){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(e)}makeWholeWordRegex(e,t){let r=t?"g":"gi";return this.containsCJK(e)?new RegExp(this.escapeRegex(e),r):new RegExp(`(^|\\W)${this.escapeRegex(e)}(\\W|$)`,r)}textMatch(e,t,r={}){let{caseSensitive:n=!1,wholeWords:i=!1}=r;if(t.startsWith("/")&&t.lastIndexOf("/")>0)try{let o=t.lastIndexOf("/"),c=t.slice(1,o),l=t.slice(o+1)||(n?"":"i");return new RegExp(c,l).test(e)}catch{return!1}let s=n?e:e.toLowerCase(),a=n?t:t.toLowerCase();if(i){if(this.makeWholeWordRegex(a,n).test(e))return!0}else if(s.includes(a))return!0;return!1}calculateActivationScore(e,t,r){let n=0;e.constant&&(n+=1e3),n+=(e.priority||0)*100,n+=(e.order||0)*10;for(let i of r)n+=i.length;return e.probability!==void 0&&(n+=e.probability*50),n}calculateGroupBonus(e,t){return e.group?t.filter(n=>n.group===e.group).length*10:0}resolveInclusionGroups(e){let t={},r=[];for(let i of e)i.group?(t[i.group]||(t[i.group]=[]),t[i.group].push(i)):r.push(i);let n=[...r];for(let[i,s]of Object.entries(t)){let a=this.selectFromGroup(s);a&&n.push(a)}return n}selectFromGroup(e){if(e.length<=1)return e[0]??null;let t=e.some(a=>a.useGroupScoring),r=e.some(a=>a.prioritizeInclusion),n=e;if(t){let a=Math.max(...n.map(o=>o.activationScore??0));n=n.filter(o=>(o.activationScore??0)===a)}if(r)return n.reduce((a,o)=>(o.order??0)>(a.order??0)?o:a);let i=n.reduce((a,o)=>a+(o.groupWeight??100),0),s=this.rand()*i;for(let a of n)if(s-=a.groupWeight??100,s<=0)return a;return n[0]}minActivationScan(e,t,r,n){let i=n.minActivations??1;if(e.length>=i)return e;let s=i-e.length,a=t.entries.filter(c=>c.enabled&&!e.some(l=>l.id===c.id));a.sort((c,l)=>(l.priority||0)-(c.priority||0));let o=[];for(let c=0;c<Math.min(s,a.length);c++){let l=a[c];o.push(this.createActivatedEntry(l,[],0,r))}return[...e,...o]}calculateTotalTokens(e){return e.reduce((t,r)=>t+this.estimateTokens(r.content),0)}estimateTokens(e){return Math.ceil(e.length/4)}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};var v={weather:["\u5929\u6C14","\u6C14\u5019","\u4E0B\u96E8","\u53F0\u98CE","\u6E29\u5EA6","\u9884\u62A5","\u9884\u8B66"],restaurant:["\u9910\u5385","\u7F8E\u98DF","\u5403\u996D","\u9910\u9986","\u996D\u5E97","\u5C0F\u5403"],travel:["\u65C5\u884C","\u65C5\u6E38","\u884C\u7A0B","\u51FA\u884C"],tips:["\u6CE8\u610F\u4E8B\u9879","\u8D34\u58EB","\u63D0\u793A"],safety:["\u5B89\u5168","\u98CE\u9669","\u5371\u9669","\u9884\u8B66"],attraction:["\u666F\u70B9","\u516C\u56ED","\u6D77\u6E7E","\u6C99\u6EE9","\u73A9"],shopping:["\u8D2D\u7269","\u514D\u7A0E\u5E97","\u7279\u4EA7"],food:["\u7F8E\u98DF","\u83DC","\u5C0F\u5403","\u7279\u8272"],hainan:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],haikou:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],sanya:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"],yalong:["\u6D77\u5357","\u6D77\u53E3","\u4E09\u4E9A","\u4E9A\u9F99\u6E7E"]},h=class{static import(e){if(!e||typeof e!="object")throw new Error("Invalid worldbook data");let t={...e};return t.worldbook&&Array.isArray(t.worldbook)&&!t.entries&&(t.entries=t.worldbook,delete t.worldbook),Array.isArray(t.entries)||(t.entries=[]),t.entries=t.entries.map((r,n)=>{let i={...r},s=[],a=["keys","key","keywords","primary_keys","\u5173\u952E\u8BCD","\u89E6\u53D1\u8BCD"];for(let o of a)if(i[o]){if(typeof i[o]=="string")s.push(...i[o].split(/[,\s、，;；|\/]+/).map(c=>c.trim()).filter(c=>c.length>0));else if(Array.isArray(i[o]))s.push(...i[o]);else if(typeof i[o]=="object"&&i[o].primary){let c=Array.isArray(i[o].primary)?i[o].primary:[],l=Array.isArray(i[o].secondary)?i[o].secondary:[];s.push(...c),l.length>0&&(i.optionalFilter=i.optionalFilter||{keys:[],logic:"AND_ANY"},i.optionalFilter.keys=l)}o!=="keys"&&delete i[o]}if(i.keys=s.length>0?this.expandEnglishKeys(s):[],!i.content&&i.content!==""&&(i.entry?(i.content=i.entry,delete i.entry):i.text?(i.content=i.text,delete i.text):i.content=""),i.enabled===void 0&&(i.enabled=!0),typeof i.position=="number"){let o={0:"before_char",1:"after_char",2:"before_example",3:"after_example",4:"before_an",5:"after_an",6:"at_depth"};i.position=o[i.position]||"after_char"}else if(typeof i.position=="string"){let o={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth",top:"before_char",beforeMain:"before_an",afterMain:"after_an",afterSystem:"after_char",bottom:"after_char",floating:"after_char",unknown:"after_char"};i.position=o[i.position]||i.position}else i.position||(i.position="after_char");return!i.id&&i.id!==0&&(i.id=`entry_${n}`),i}),t}static expandEnglishKeys(e){let t=[...e];for(let r of e){let n=r.toLowerCase();v[n]&&t.push(...v[n])}return[...new Set(t.map(r=>r.replace(/[\uFF01-\uFF5E]/g,n=>String.fromCharCode(n.charCodeAt(0)-65248)).replace(/\u3000/g," ").trim()))].filter(r=>r.length>0)}static validate(e){if(!e||typeof e!="object")return{valid:!1,errors:["Worldbook must be an object"]};if(!Array.isArray(e.entries))return{valid:!1,errors:["Worldbook must have an entries array"]};let t=[];return e.entries.forEach((r,n)=>{!r.id&&r.id!==0&&t.push(`Entry at index ${n} is missing id`),Array.isArray(r.keys)||t.push(`Entry at index ${n} is missing keys array`),!r.content&&r.content!==""&&t.push(`Entry at index ${n} is missing content`)}),{valid:t.length===0,errors:t}}static export(e){return{name:e.name,description:e.description,version:e.version,entries:e.entries.map(t=>({id:t.id,name:t.name,keys:t.keys,content:t.content,enabled:t.enabled,position:t.position,priority:t.priority,order:t.order,constant:t.constant,selectiveLogic:t.selectiveLogic,caseSensitive:t.caseSensitive,matchWholeWords:t.matchWholeWords,optionalFilter:t.optionalFilter,group:t.group,probability:t.probability,recursive:t.recursive,sticky:t.sticky,cooldown:t.cooldown,delay:t.delay,nonRecursable:t.nonRecursable,blockFurther:t.blockFurther,delayLevel:t.delayLevel,maxRecursionSteps:t.maxRecursionSteps})),settings:e.settings,metadata:e.metadata}}};return _(x);})();
