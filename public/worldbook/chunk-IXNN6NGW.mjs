var h=class{constructor(e={}){this.activationHistory=new Map;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...e}}setOptions(e){this.settings={...this.settings,...e}}process(e,s){let i=performance.now(),t=typeof s=="string"?{text:s,currentTime:Date.now()}:{currentTime:Date.now(),...s},n={...this.settings,...e.settings};this.settings=n;let r=this.selectCandidates(e.entries,t),o=this.applyFilters(r,t),a=this.applyTimeFilters(o,t),c=this.applyScoring(a,t),l=this.applyProbabilityFilter(c,t),u=this.handleRecursion(l,e.entries,t),p=this.applyBudgetLimits(u),g=this.organizeByPosition(p),f=performance.now();return{slots:g,activatedEntries:p,totalTokens:this.calculateTotalTokens(p),processTime:f-i}}selectCandidates(e,s){let i=[];for(let t of e){if(!t.enabled)continue;if(t.constant){i.push(this.createActivatedEntry(t,[],0,s));continue}let n=this.matchKeys(t,s.text);if(n.length>0){let r=t.minActivations??this.settings.minActivations??1;if(t.selectiveLogic){let o=t.selectiveLogic.includes("AND")?t.keys.length:1;n.length>=o&&i.push(this.createActivatedEntry(t,n,0,s))}else n.length>=r&&i.push(this.createActivatedEntry(t,n,0,s))}}return i}applyFilters(e,s){return e.filter(i=>{if(i.optionalFilter){let t=i.optionalFilter,r=(t.keys||[]).map(a=>this.textMatch(s.text,a,{caseSensitive:i.caseSensitive??this.settings.caseSensitive??!1,wholeWords:!1}));if(!(t.logic==="AND_ALL"?r.every(Boolean):t.logic==="NOT_ANY"?!r.some(Boolean):t.logic==="NOT_ALL"?!r.every(Boolean):r.some(Boolean)))return!1}return!0})}applyTimeFilters(e,s){let i=s.currentTime??Date.now(),t=[];for(let n of e){let r=this.activationHistory.get(n.id);r?.cooldownUntil&&i<r.cooldownUntil||n.delay&&(!r||i-r.time<n.delay*1e3)||(n.sticky&&r?.stickyUntil&&i<r.stickyUntil&&(n.activationScore=(n.activationScore||0)+1e3),t.push(n))}return t}applyScoring(e,s){for(let i of e){let t=0;i.constant&&(t+=1e3),t+=(i.priority||0)*100,t+=(i.order||0)*10;for(let n of i.matchedKeys)t+=n.length;if(i.probability!==void 0&&(t+=i.probability*50),i.activationScore=t,this.settings.useGroupScoring&&i.group){let n=this.calculateGroupBonus(i,e);i.groupScore=n,i.activationScore+=n}}return e.sort((i,t)=>(t.activationScore||0)-(i.activationScore||0))}applyProbabilityFilter(e,s){let i=s.currentTime??Date.now();return e.filter(t=>{let n=this.activationHistory.get(t.id);return t.sticky&&n?.stickyUntil&&i<n.stickyUntil?!0:!(t.probability!==void 0&&Math.random()>t.probability)})}handleRecursion(e,s,i,t=0){if(!this.settings.recursive||t>=(this.settings.maxDepth??3))return e;let n=[...e],r=this.settings.maxRecursionSteps??10;for(let o of e)if(!(o.nonRecursable||t>=r)&&o.recursive!==!1&&o.content){let a={...i,text:o.content},c=this.selectCandidates(s,a),l=this.applyFilters(c,a);for(let u of l)u.depth=t+1,n.push(u);if(o.blockFurther)break}if(n.length===e.length&&this.settings.minActivations){let o=this.ensureMinimumActivations(s,i);n.push(...o)}return n}applyBudgetLimits(e){let s=this.settings.tokenBudget??2e3,i=this.settings.contextPercent??.7,t=Math.floor(s*i),n=0,r=[],o={},a=[];for(let c of e)c.group?(o[c.group]||(o[c.group]=[]),o[c.group].push(c)):a.push(c);for(let[c,l]of Object.entries(o))if(l.sort((u,p)=>(p.activationScore||0)-(u.activationScore||0)),l.length>0){let u=this.estimateTokens(l[0].content);n+u<=t&&(r.push(l[0]),n+=u)}for(let c of a){let l=this.estimateTokens(c.content);if(n+l<=t)r.push(c),n+=l;else break}return r}organizeByPosition(e){let s={before_char:[],after_char:[],before_example:[],after_example:[],before_an:[],after_an:[],at_depth:[]};for(let i of e){let t=i.position||"after_char";s[t]?s[t].push(i):s.after_char.push(i)}for(let i in s)s[i].sort((t,n)=>(t.order||0)-(n.order||0));return Object.entries(s).filter(([i,t])=>t.length>0).map(([i,t])=>({position:i,entries:t}))}createActivatedEntry(e,s,i,t){let n={...e,matchedKeys:s,depth:i,activationScore:this.calculateActivationScore(e,t.text,s),activationTime:t.currentTime},r=t.currentTime??Date.now(),o={time:r,stickyUntil:e.sticky?r+e.sticky*1e3:void 0,cooldownUntil:e.cooldown?r+e.cooldown*1e3:void 0};return this.activationHistory.set(e.id,o),n}matchKeys(e,s){let i=[],t=e.caseSensitive??this.settings.caseSensitive??!1,n=e.matchWholeWords??this.settings.matchWholeWords??!1;for(let r of e.keys||[])this.textMatch(s,r,{caseSensitive:t,wholeWords:n})&&i.push(r);return i}textMatch(e,s,i={}){let{caseSensitive:t=!1,wholeWords:n=!1}=i,r=t?e:this.toHalfWidth(e).toLowerCase(),o=t?s:this.toHalfWidth(s).toLowerCase();if(o.startsWith("/")&&o.lastIndexOf("/")>0)try{let a=o.lastIndexOf("/"),c=o.slice(1,a),l=o.slice(a+1)||(t?"":"i");return new RegExp(c,l).test(e)}catch{return!1}return this.hasCJK(o)||this.hasCJK(r)?r.includes(o):n?new RegExp(`\\b${this.escapeRegex(o)}\\b`,t?"":"i").test(e):r.includes(o)}calculateActivationScore(e,s,i){let t=0;e.constant&&(t+=1e3),t+=(e.priority||0)*100,t+=(e.order||0)*10;for(let n of i)t+=n.length;return e.probability!==void 0&&(t+=e.probability*50),t}calculateGroupBonus(e,s){return e.group?s.filter(t=>t.group===e.group).length*10:0}ensureMinimumActivations(e,s){return[]}calculateTotalTokens(e){return e.reduce((s,i)=>s+this.estimateTokens(i.content),0)}estimateTokens(e){return Math.ceil(e.length/4)}toHalfWidth(e){return e.replace(/[\uFF01-\uFF5E]/g,s=>String.fromCharCode(s.charCodeAt(0)-65248)).replace(/\u3000/g," ")}hasCJK(e){return/[\u3400-\u9FFF\uF900-\uFAFF]/.test(e||"")}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{h as a};
