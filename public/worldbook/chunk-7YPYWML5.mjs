var p=class{constructor(t={}){this.timedEffectsState=new Map;this.rand=Math.random;if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let n=t.seed>>>0||1;this.rand=()=>((n=1664525*n+1013904223>>>0)&4294967295)/4294967296}else this.rand=Math.random;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...t}}setOptions(t){this.settings={...this.settings,...t}}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let n of t){let i=this.timedEffectsState.get(n.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};n.sticky&&(i.stickyRemaining=n.sticky),n.cooldown&&(i.cooldownRemaining=n.cooldown),this.timedEffectsState.set(n.id,i)}}process(t,n){let i=performance.now();this.tickTimedEffects();let e=typeof n=="string"?{text:n,currentTime:Date.now()}:{currentTime:Date.now(),...n},o={...this.settings,...t.settings};this.settings=o;let s=this.selectCandidates(t.entries,e);s=this.applyFilters(s,e),s=this.applyTimedEffects(s,e),s=this.applyProbability(s),!!this.settings.recursiveScan&&(this.settings.maxRecursionSteps??0)!==0?s=this.recursiveScan(s,t,e,this.settings):(this.settings.minActivations??0)>0&&(s=this.minActivationScan(s,t,e,this.settings)),s=this.applyBudget(s,this.settings),this.commitTimedEffects(s);let a=this.distributeToSlots(s),c=performance.now();return{slots:a,activatedEntries:s,totalTokens:this.calculateTotalTokens(s),processTime:c-i}}selectCandidates(t,n){let i=[];for(let e of t){if(!e.enabled)continue;if(e.constant){i.push(this.createActivatedEntry(e,[],0,n));continue}let o=this.matchKeys(e,n.text);if(o.length>0){let s=e.minActivations??this.settings.minActivations??1;if(e.selectiveLogic){let r=e.selectiveLogic.includes("AND")?e.keys.length:1;o.length>=r&&i.push(this.createActivatedEntry(e,o,0,n))}else o.length>=s&&i.push(this.createActivatedEntry(e,o,0,n))}}return i}applyFilters(t,n){return t.filter(i=>{if(i.optionalFilter){let e=i.optionalFilter,o=i.caseSensitive??this.settings.caseSensitive??!1,s=n.text,r=o?s:s.toLowerCase(),a=e.keys.map(l=>o?l:l.toLowerCase()).map(l=>r.includes(l));if(!(e.logic==="AND_ALL"?a.every(Boolean):e.logic==="NOT_ANY"?!a.some(Boolean):e.logic==="NOT_ALL"?!a.every(Boolean):a.some(Boolean)))return!1}return!0})}applyTimedEffects(t,n){let i=[],e=n?.chatHistory?.length??0;for(let o of t){let s=this.timedEffectsState.get(o.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(o.delay&&e<o.delay||s.cooldownRemaining>0)continue;let r={...o};s.stickyRemaining>0&&(r.stickyRemaining=s.stickyRemaining),i.push(r)}return i}applyScoring(t,n){for(let i of t){let e=0;i.constant&&(e+=1e3),e+=(i.priority||0)*100,e+=(i.order||0)*10;for(let o of i.matchedKeys)e+=o.length;if(i.probability!==void 0&&(e+=i.probability*50),i.activationScore=e,this.settings.useGroupScoring&&i.group){let o=this.calculateGroupBonus(i,t);i.groupScore=o,i.activationScore+=o}}return t.sort((i,e)=>(e.activationScore||0)-(i.activationScore||0))}applyProbability(t){return t.filter(n=>n.stickyRemaining&&n.stickyRemaining>0?!0:this.rand()<(n.probability??100)/100)}recursiveScan(t,n,i,e){let o=[...t],s=new Set(o.map(c=>c.id)),r=1,a=!1;for(;!a&&r<=(e.maxRecursionSteps??2);){let c=o.map(u=>u.content).join(`
`),l=[];for(let u of n.entries){if(s.has(u.id)||u.nonRecursable||u.delayLevel&&r<u.delayLevel)continue;let d=this.matchKeys(u,c);d.length>0&&l.push({...u,matchedKeys:d,recursionLevel:r,activationScore:d.length,depth:r})}if(l.length===0)break;let f=this.resolveInclusionGroups(l);f=this.applyProbability(f),o.push(...f),f.forEach(u=>s.add(u.id)),f.some(u=>u.blockFurther)&&(a=!0),r++}return o}applyBudget(t,n){let i=n.tokenBudget??2e3,e=n.contextPercent??.7,o=Math.floor(i*e),s=0,r=[];t.sort((a,c)=>(c.activationScore||0)-(a.activationScore||0));for(let a of t){let c=this.estimateTokens(a.content);if(s+c<=o)r.push(a),s+=c;else break}return r}distributeToSlots(t){let n=new Map,i={before_char:"before_char",after_char:"after_char",before_example:"before_example",after_example:"after_example",before_an:"before_an",after_an:"after_an",at_depth:"at_depth"};for(let s of t){let r=s.position||"after_char",a=i[r]||"after_char";n.has(a)||n.set(a,{position:a,entries:[],depth:s.depth,role:s.role}),n.get(a).entries.push(s)}let e=s=>{let r=a=>a==="system"?0:a==="user"?1:2;switch(s.position){case"before_an":return 0;case"before_char":return 1;case"before_example":return 2;case"at_depth":return 3+(s.depth??0)*.01+r(s.role)*.001;case"after_example":return 4;case"after_char":return 5;case"after_an":return 6;default:return 5}};for(let s of n.values())s.entries.sort((r,a)=>(r.order||0)-(a.order||0));return Array.from(n.values()).sort((s,r)=>e(s)-e(r))}createActivatedEntry(t,n,i,e){return{...t,matchedKeys:n,depth:i,activationScore:this.calculateActivationScore(t,e.text,n),activationTime:e.currentTime}}matchKeys(t,n){let i=[],e=t.caseSensitive??this.settings.caseSensitive??!1,o=t.matchWholeWords??this.settings.matchWholeWords??!1;for(let s of t.keys||[]){let r=e?n:n.toLowerCase(),a=e?s:s.toLowerCase();o?this.makeWholeWordRegex(a,e).test(n)&&i.push(s):r.includes(a)&&i.push(s)}return i}containsCJK(t){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(t)}makeWholeWordRegex(t,n){let i=n?"g":"gi";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),i):new RegExp(`(^|\\W)${this.escapeRegex(t)}(\\W|$)`,i)}textMatch(t,n,i={}){let{caseSensitive:e=!1,wholeWords:o=!1}=i;if(n.startsWith("/")&&n.lastIndexOf("/")>0)try{let a=n.lastIndexOf("/"),c=n.slice(1,a),l=n.slice(a+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let s=e?t:t.toLowerCase(),r=e?n:n.toLowerCase();if(o){if(this.makeWholeWordRegex(r,e).test(t))return!0}else if(s.includes(r))return!0;return!1}calculateActivationScore(t,n,i){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let o of i)e+=o.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,n){return t.group?n.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let n={},i=[];for(let o of t)o.group?(n[o.group]||(n[o.group]=[]),n[o.group].push(o)):i.push(o);let e=[...i];for(let[o,s]of Object.entries(n)){let r=this.selectFromGroup(s);r&&e.push(r)}return e}selectFromGroup(t){if(t.length<=1)return t[0]??null;let n=t.some(r=>r.useGroupScoring),i=t.some(r=>r.prioritizeInclusion),e=t;if(n){let r=Math.max(...e.map(a=>a.activationScore??0));e=e.filter(a=>(a.activationScore??0)===r)}if(i)return e.reduce((r,a)=>(a.order??0)>(r.order??0)?a:r);let o=e.reduce((r,a)=>r+(a.groupWeight??100),0),s=this.rand()*o;for(let r of e)if(s-=r.groupWeight??100,s<=0)return r;return e[0]}minActivationScan(t,n,i,e){let o=e.minActivations??1;if(t.length>=o)return t;let s=o-t.length,r=n.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));r.sort((c,l)=>(l.priority||0)-(c.priority||0));let a=[];for(let c=0;c<Math.min(s,r.length);c++){let l=r[c];a.push(this.createActivatedEntry(l,[],0,i))}return[...t,...a]}calculateTotalTokens(t){return t.reduce((n,i)=>n+this.estimateTokens(i.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{p as a};
