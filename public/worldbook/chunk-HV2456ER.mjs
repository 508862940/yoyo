var v=class{constructor(t){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let i=t.seed>>>0||1;this.rand=()=>((i=1664525*i+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(t){this.runtimeOptions={...this.runtimeOptions,...t}}process(t,i){let o={...this.getDefaultSettings(),...t.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(o.recursiveScan=!!this.runtimeOptions.recursive);let e=this.activate({...t,settings:o},{scanText:i,chatHistory:[],generationType:"Normal"}),r=e.flatMap(n=>n.entries),s=r.map(n=>n.content).join(`
`),a=this.calculateTotalTokens(r);return{activatedEntries:r,slots:e,finalPrompt:s,totalTokens:a}}activate(t,i){this.tickTimedEffects();let o=t.settings||this.getDefaultSettings(),e=this.selectCandidates(t.entries,i,o);e=this.applyFilters(e,i,o),e=this.applyTimedEffects(e,o),e=this.applyProbability(e),e=this.resolveInclusionGroups(e),e=this.applyScoring(e,i,o),e=this.applyBudget(e,o);let r=e.some(a=>a.nonRecursable||a.blockFurther);this.commitTimedEffects(e);let s=!!o.recursiveScan&&(o.maxRecursionSteps??0)>0;return!r&&s?e=this.recursiveScan(e,t,i,o):!s&&(o.minActivations??0)>0&&(e=this.minActivationScan(e,t,i,o)),this.distributeToSlots(e)}selectCandidates(t,i,o){let e=[],r=i.scanText||"";for(let s of t){if(!(s.enabled!==!1))continue;if(s.constant){e.push(this.createActivatedEntry(s,[],0,i));continue}let n=this.matchKeys(s,r,o);if(n.length>0){let c=s.minActivations??o.minActivations??1;if(s.selectiveLogic){let l=s.selectiveLogic.includes("AND")?s.keys.length:1;n.length>=l&&e.push(this.createActivatedEntry(s,n,0,i))}else n.length>=c&&e.push(this.createActivatedEntry(s,n,0,i))}}return e}applyFilters(t,i,o){return t.filter(e=>{if(e.optionalFilter){let r=e.optionalFilter,s=e.caseSensitive??o.caseSensitive??!1,a=i.scanText||"",n=s?a:a.toLowerCase(),c=r.keys.map(f=>s?f:f.toLowerCase()).map(f=>n.includes(f));if(!(r.logic==="AND_ALL"?c.every(Boolean):r.logic==="NOT_ANY"?!c.some(Boolean):r.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let i of t){let o=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};i.sticky&&(o.stickyRemaining=i.sticky),i.cooldown&&(o.cooldownRemaining=i.cooldown),this.timedEffectsState.set(i.id,o)}}applyTimedEffects(t,i){let o=[],e=i?.chatHistory?.length??0;for(let r of t){let s=this.timedEffectsState.get(r.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(r.delay&&e<r.delay||s.cooldownRemaining>0)continue;let a={...r};s.stickyRemaining>0&&(a.stickyRemaining=s.stickyRemaining),o.push(a)}return o}applyScoring(t,i,o){for(let e of t){let r=0;e.constant&&(r+=1e3),r+=(e.priority||0)*100,r+=(e.order||0)*10;for(let s of e.matchedKeys)r+=s.length;if(e.probability!==void 0&&(r+=e.probability*50),e.activationScore=r,e.score=r,o.useGroupScoring&&e.group){let s=this.calculateGroupBonus(e,t);e.groupScore=s,e.activationScore+=s}}return t.sort((e,r)=>(r.activationScore||0)-(e.activationScore||0))}getProb(t){let i=t?.probability??t?.useProbability??t?.prob;return(i==null||i===""||Number.isNaN(Number(i)))&&(i=100),i=Number(i),i<=1&&i>=0&&(i=i*100),i=Math.max(0,Math.min(100,i)),i}applyProbability(t){return t.filter(i=>i.stickyRemaining&&i.stickyRemaining>0?!0:this.rand()*100<=this.getProb(i))}recursiveScan(t,i,o,e){let r=[...t],s=new Set(r.map(n=>n.id)),a=1;for(;a<=(e.maxRecursionSteps??2);){let n=r.map(u=>u.content).join(`
`),c=[];for(let u of i.entries){if(s.has(u.id)||u.delayLevel&&a<u.delayLevel)continue;let p=this.matchKeys(u,n,e);p.length>0&&c.push({...u,matchedKeys:p,recursionLevel:a,score:p.length,depth:a,activationScore:p.length})}if(c.length===0)break;let l=c.some(u=>u.nonRecursable||u.blockFurther),f=this.resolveInclusionGroups(c);if(f=this.applyProbability(f),r.push(...f),f.forEach(u=>s.add(u.id)),l||f.some(u=>u.blockFurther))break;a++}return r}applyBudget(t,i){let o=i.tokenBudget??2e3,e=i.contextPercent??.7,r=Math.floor(o*e),s=0,a=[];t.sort((n,c)=>(c.activationScore||0)-(n.activationScore||0));for(let n of t){let c=this.estimateTokens(n.content);if(s+c<=r)a.push(n),s+=c;else break}return a}distributeToSlots(t){let i=new Map;for(let n of t){let c=`${n.position||"after_char"}_${n.depth||0}_${n.role||"system"}`;i.has(c)||i.set(c,{position:n.position||"after_char",depth:n.depth,role:n.role,entries:[]}),i.get(c).entries.push(n)}for(let n of i.values())n.entries.sort((c,l)=>{let f=c.order??0,u=l.order??0;return f!==u?f-u:(c.id??"").localeCompare(l.id??"")});let o=n=>n==="system"?0:n==="user"?1:2,e={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},r=0,s=new Map;for(let n of i.values())s.set(n,r++);return Array.from(i.values()).sort((n,c)=>{let l=e[n.position]??5,f=e[c.position]??5;if(l!==f)return l-f;let u=n.depth??0,p=c.depth??0;if(u!==p)return u-p;let d=o(n.role)-o(c.role);return d!==0?d:s.get(n)-s.get(c)})}createActivatedEntry(t,i,o,e){return{...t,matchedKeys:i,depth:o,activationScore:this.calculateActivationScore(t,e.scanText||"",i),activationTime:Date.now()}}matchKeys(t,i,o){let e=[],r=t.caseSensitive??o?.caseSensitive??!1,s=t.matchWholeWords??o?.matchWholeWords??!1;for(let a of t.keys||[]){let n=r?i:i.toLowerCase(),c=r?a:a.toLowerCase();s?this.makeWholeWordRegex(a,r).test(i)&&e.push(a):n.includes(c)&&e.push(a)}return e}containsCJK(t){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(t)}makeWholeWordRegex(t,i){let o=i?"g":"gi";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),o):new RegExp(`(^|\\W)${this.escapeRegex(t)}(\\W|$)`,o)}textMatch(t,i,o={}){let{caseSensitive:e=!1,wholeWords:r=!1}=o;if(i.startsWith("/")&&i.lastIndexOf("/")>0)try{let n=i.lastIndexOf("/"),c=i.slice(1,n),l=i.slice(n+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let s=e?t:t.toLowerCase(),a=e?i:i.toLowerCase();if(r){if(this.makeWholeWordRegex(a,e).test(t))return!0}else if(s.includes(a))return!0;return!1}calculateActivationScore(t,i,o){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let r of o)e+=r.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,i){return t.group?i.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let i=new Map,o=[];for(let r of t){let s=r.inclusionGroup||r.group;if(s){let a=i.get(s)??[];a.push(r),i.set(s,a)}else o.push(r)}let e=[];for(let[,r]of i){let s=this.selectFromGroup(r);s&&e.push(s)}return[...e,...o]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let i=t.some(a=>a.useGroupScoring),o=t.some(a=>a.prioritizeInclusion),e=t;if(i){let a=Math.max(...e.map(n=>n.score??0));e=e.filter(n=>(n.score??0)===a)}if(o)return e.reduce((a,n)=>{let c=a.priority??0,l=n.priority??0;return c!==l?l>c?n:a:(n.order??0)>(a.order??0)?n:a});let r=e.reduce((a,n)=>a+(n.groupWeight??100),0),s=this.rand()*r;for(let a of e)if(s-=a.groupWeight??100,s<=0)return a;return e[0]}minActivationScan(t,i,o,e){let r=e.minActivations??1;if(t.length>=r)return t;let s=r-t.length,a=i.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));a.sort((c,l)=>(l.priority||0)-(c.priority||0));let n=[];for(let c=0;c<Math.min(s,a.length);c++){let l=a[c];n.push(this.createActivatedEntry(l,[],0,o))}return[...t,...n]}calculateTotalTokens(t){return t.reduce((i,o)=>i+this.estimateTokens(o.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{v as a};
