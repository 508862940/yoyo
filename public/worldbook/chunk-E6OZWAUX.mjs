var v=class{constructor(t){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let i=t.seed>>>0||1;this.rand=()=>((i=1664525*i+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(t){this.runtimeOptions={...this.runtimeOptions,...t}}process(t,i){let s={...this.getDefaultSettings(),...t.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(s.recursiveScan=!!this.runtimeOptions.recursive);let e=this.activate({...t,settings:s},{scanText:i,chatHistory:[],generationType:"Normal"}),r=e.flatMap(o=>o.entries),a=r.map(o=>o.content).join(`
`),n=this.calculateTotalTokens(r);return{activatedEntries:r,slots:e,finalPrompt:a,totalTokens:n}}activate(t,i){this.tickTimedEffects();let s=t.settings||this.getDefaultSettings(),e=this.selectCandidates(t.entries,i,s);e=this.applyFilters(e,i,s),e=this.applyTimedEffects(e,s),e=this.applyProbability(e),e=this.resolveInclusionGroups(e),e=this.applyScoring(e,i,s),e=this.applyBudget(e,s);let r=e.some(n=>n.nonRecursable||n.blockFurther);this.commitTimedEffects(e);let a=!!s.recursiveScan&&(s.maxRecursionSteps??0)>0;return!r&&a?e=this.recursiveScan(e,t,i,s):!a&&(s.minActivations??0)>0&&(e=this.minActivationScan(e,t,i,s)),this.distributeToSlots(e)}selectCandidates(t,i,s){let e=[],r=i.scanText||"";for(let a of t){if(!a.enabled)continue;if(a.constant){e.push(this.createActivatedEntry(a,[],0,i));continue}let n=this.matchKeys(a,r,s);if(n.length>0){let o=a.minActivations??s.minActivations??1;if(a.selectiveLogic){let c=a.selectiveLogic.includes("AND")?a.keys.length:1;n.length>=c&&e.push(this.createActivatedEntry(a,n,0,i))}else n.length>=o&&e.push(this.createActivatedEntry(a,n,0,i))}}return e}applyFilters(t,i,s){return t.filter(e=>{if(e.optionalFilter){let r=e.optionalFilter,a=e.caseSensitive??s.caseSensitive??!1,n=i.scanText||"",o=a?n:n.toLowerCase(),c=r.keys.map(f=>a?f:f.toLowerCase()).map(f=>o.includes(f));if(!(r.logic==="AND_ALL"?c.every(Boolean):r.logic==="NOT_ANY"?!c.some(Boolean):r.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let i of t){let s=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};i.sticky&&(s.stickyRemaining=i.sticky),i.cooldown&&(s.cooldownRemaining=i.cooldown),this.timedEffectsState.set(i.id,s)}}applyTimedEffects(t,i){let s=[],e=i?.chatHistory?.length??0;for(let r of t){let a=this.timedEffectsState.get(r.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(r.delay&&e<r.delay||a.cooldownRemaining>0)continue;let n={...r};a.stickyRemaining>0&&(n.stickyRemaining=a.stickyRemaining),s.push(n)}return s}applyScoring(t,i,s){for(let e of t){let r=0;e.constant&&(r+=1e3),r+=(e.priority||0)*100,r+=(e.order||0)*10;for(let a of e.matchedKeys)r+=a.length;if(e.probability!==void 0&&(r+=e.probability*50),e.activationScore=r,e.score=r,s.useGroupScoring&&e.group){let a=this.calculateGroupBonus(e,t);e.groupScore=a,e.activationScore+=a}}return t.sort((e,r)=>(r.activationScore||0)-(e.activationScore||0))}getProb(t){let i=t?.probability??t?.useProbability??t?.prob;return(i==null||i===""||Number.isNaN(Number(i)))&&(i=100),i=Number(i),i<=1&&i>=0&&(i=i*100),i=Math.max(0,Math.min(100,i)),i}applyProbability(t){return t.filter(i=>i.stickyRemaining&&i.stickyRemaining>0?!0:this.rand()*100<=this.getProb(i))}recursiveScan(t,i,s,e){let r=[...t],a=new Set(r.map(o=>o.id)),n=1;for(;n<=(e.maxRecursionSteps??2);){let o=r.map(u=>u.content).join(`
`),c=[];for(let u of i.entries){if(a.has(u.id)||u.delayLevel&&n<u.delayLevel)continue;let p=this.matchKeys(u,o,e);p.length>0&&c.push({...u,matchedKeys:p,recursionLevel:n,score:p.length,depth:n,activationScore:p.length})}if(c.length===0)break;let l=c.some(u=>u.nonRecursable||u.blockFurther),f=this.resolveInclusionGroups(c);if(f=this.applyProbability(f),r.push(...f),f.forEach(u=>a.add(u.id)),l||f.some(u=>u.blockFurther))break;n++}return r}applyBudget(t,i){let s=i.tokenBudget??2e3,e=i.contextPercent??.7,r=Math.floor(s*e),a=0,n=[];t.sort((o,c)=>(c.activationScore||0)-(o.activationScore||0));for(let o of t){let c=this.estimateTokens(o.content);if(a+c<=r)n.push(o),a+=c;else break}return n}distributeToSlots(t){let i=new Map;for(let o of t){let c=`${o.position||"after_char"}_${o.depth||0}_${o.role||"system"}`;i.has(c)||i.set(c,{position:o.position||"after_char",depth:o.depth,role:o.role,entries:[]}),i.get(c).entries.push(o)}for(let o of i.values())o.entries.sort((c,l)=>{let f=c.order??0,u=l.order??0;return f!==u?f-u:(c.id??"").localeCompare(l.id??"")});let s=o=>o==="system"?0:o==="user"?1:2,e={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},r=0,a=new Map;for(let o of i.values())a.set(o,r++);return Array.from(i.values()).sort((o,c)=>{let l=e[o.position]??5,f=e[c.position]??5;if(l!==f)return l-f;let u=o.depth??0,p=c.depth??0;if(u!==p)return u-p;let d=s(o.role)-s(c.role);return d!==0?d:a.get(o)-a.get(c)})}createActivatedEntry(t,i,s,e){return{...t,matchedKeys:i,depth:s,activationScore:this.calculateActivationScore(t,e.scanText||"",i),activationTime:Date.now()}}matchKeys(t,i,s){let e=[],r=t.caseSensitive??s?.caseSensitive??!1,a=t.matchWholeWords??s?.matchWholeWords??!1;for(let n of t.keys||[]){let o=r?i:i.toLowerCase(),c=r?n:n.toLowerCase();a?this.makeWholeWordRegex(n,r).test(i)&&e.push(n):o.includes(c)&&e.push(n)}return e}containsCJK(t){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(t)}makeWholeWordRegex(t,i){let s=i?"g":"gi";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),s):new RegExp(`(^|\\W)${this.escapeRegex(t)}(\\W|$)`,s)}textMatch(t,i,s={}){let{caseSensitive:e=!1,wholeWords:r=!1}=s;if(i.startsWith("/")&&i.lastIndexOf("/")>0)try{let o=i.lastIndexOf("/"),c=i.slice(1,o),l=i.slice(o+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let a=e?t:t.toLowerCase(),n=e?i:i.toLowerCase();if(r){if(this.makeWholeWordRegex(n,e).test(t))return!0}else if(a.includes(n))return!0;return!1}calculateActivationScore(t,i,s){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let r of s)e+=r.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,i){return t.group?i.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let i=new Map,s=[];for(let r of t){let a=r.inclusionGroup||r.group;if(a){let n=i.get(a)??[];n.push(r),i.set(a,n)}else s.push(r)}let e=[];for(let[,r]of i){let a=this.selectFromGroup(r);a&&e.push(a)}return[...e,...s]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let i=t.some(n=>n.useGroupScoring),s=t.some(n=>n.prioritizeInclusion),e=t;if(i){let n=Math.max(...e.map(o=>o.score??0));e=e.filter(o=>(o.score??0)===n)}if(s)return e.reduce((n,o)=>{let c=n.priority??0,l=o.priority??0;return c!==l?l>c?o:n:(o.order??0)>(n.order??0)?o:n});let r=e.reduce((n,o)=>n+(o.groupWeight??100),0),a=this.rand()*r;for(let n of e)if(a-=n.groupWeight??100,a<=0)return n;return e[0]}minActivationScan(t,i,s,e){let r=e.minActivations??1;if(t.length>=r)return t;let a=r-t.length,n=i.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));n.sort((c,l)=>(l.priority||0)-(c.priority||0));let o=[];for(let c=0;c<Math.min(a,n.length);c++){let l=n[c];o.push(this.createActivatedEntry(l,[],0,s))}return[...t,...o]}calculateTotalTokens(t){return t.reduce((i,s)=>i+this.estimateTokens(s.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};export{v as a};
