"use strict";var WorldBookKit=(()=>{var g=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var A=(p,e)=>{for(var n in e)g(p,n,{get:e[n],enumerable:!0})},b=(p,e,n,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of m(e))!E.call(p,t)&&t!==n&&g(p,t,{get:()=>e[t],enumerable:!(i=y(e,t))||i.enumerable});return p};var S=p=>b(g({},"__esModule",{value:!0}),p);var k={};A(k,{WorldBookEngine:()=>f});var f=class{constructor(e={}){this.activationHistory=new Map;this.settings={scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,...e}}setOptions(e){this.settings={...this.settings,...e}}process(e,n){let i=performance.now(),t=typeof n=="string"?{text:n,currentTime:Date.now()}:{currentTime:Date.now(),...n},s={...this.settings,...e.settings};this.settings=s;let r=this.selectCandidates(e.entries,t),o=this.applyFilters(r,t),a=this.applyTimeFilters(o,t),c=this.applyScoring(a,t),l=this.applyProbabilityFilter(c,t),u=this.handleRecursion(l,e.entries,t),h=this.applyBudgetLimits(u),v=this.organizeByPosition(h),d=performance.now();return{slots:v,activatedEntries:h,totalTokens:this.calculateTotalTokens(h),processTime:d-i}}selectCandidates(e,n){let i=[];for(let t of e){if(!t.enabled)continue;if(t.constant){i.push(this.createActivatedEntry(t,[],0,n));continue}let s=this.matchKeys(t,n.text);if(s.length>0){let r=t.minActivations??this.settings.minActivations??1;if(t.selectiveLogic){let o=t.selectiveLogic.includes("AND")?t.keys.length:1;s.length>=o&&i.push(this.createActivatedEntry(t,s,0,n))}else s.length>=r&&i.push(this.createActivatedEntry(t,s,0,n))}}return i}applyFilters(e,n){return e.filter(i=>{if(i.optionalFilter){let t=i.optionalFilter,r=(t.keys||[]).map(a=>this.textMatch(n.text,a,{caseSensitive:i.caseSensitive??this.settings.caseSensitive??!1,wholeWords:!1}));if(!(t.logic==="AND_ALL"?r.every(Boolean):t.logic==="NOT_ANY"?!r.some(Boolean):t.logic==="NOT_ALL"?!r.every(Boolean):r.some(Boolean)))return!1}return!0})}applyTimeFilters(e,n){let i=n.currentTime??Date.now(),t=[];for(let s of e){let r=this.activationHistory.get(s.id);r?.cooldownUntil&&i<r.cooldownUntil||s.delay&&(!r||i-r.time<s.delay*1e3)||(s.sticky&&r?.stickyUntil&&i<r.stickyUntil&&(s.activationScore=(s.activationScore||0)+1e3),t.push(s))}return t}applyScoring(e,n){for(let i of e){let t=0;i.constant&&(t+=1e3),t+=(i.priority||0)*100,t+=(i.order||0)*10;for(let s of i.matchedKeys)t+=s.length;if(i.probability!==void 0&&(t+=i.probability*50),i.activationScore=t,this.settings.useGroupScoring&&i.group){let s=this.calculateGroupBonus(i,e);i.groupScore=s,i.activationScore+=s}}return e.sort((i,t)=>(t.activationScore||0)-(i.activationScore||0))}applyProbabilityFilter(e,n){let i=n.currentTime??Date.now();return e.filter(t=>{let s=this.activationHistory.get(t.id);return t.sticky&&s?.stickyUntil&&i<s.stickyUntil?!0:!(t.probability!==void 0&&Math.random()>t.probability)})}handleRecursion(e,n,i,t=0){if(!this.settings.recursive||t>=(this.settings.maxDepth??3))return e;let s=[...e],r=this.settings.maxRecursionSteps??10;for(let o of e)if(!(o.nonRecursable||t>=r)&&o.recursive!==!1&&o.content){let a={...i,text:o.content},c=this.selectCandidates(n,a),l=this.applyFilters(c,a);for(let u of l)u.depth=t+1,s.push(u);if(o.blockFurther)break}if(s.length===e.length&&this.settings.minActivations){let o=this.ensureMinimumActivations(n,i);s.push(...o)}return s}applyBudgetLimits(e){let n=this.settings.tokenBudget??2e3,i=this.settings.contextPercent??.7,t=Math.floor(n*i),s=0,r=[],o={},a=[];for(let c of e)c.group?(o[c.group]||(o[c.group]=[]),o[c.group].push(c)):a.push(c);for(let[c,l]of Object.entries(o))if(l.sort((u,h)=>(h.activationScore||0)-(u.activationScore||0)),l.length>0){let u=this.estimateTokens(l[0].content);s+u<=t&&(r.push(l[0]),s+=u)}for(let c of a){let l=this.estimateTokens(c.content);if(s+l<=t)r.push(c),s+=l;else break}return r}organizeByPosition(e){let n={before_char:[],after_char:[],before_example:[],after_example:[],before_an:[],after_an:[],at_depth:[]};for(let i of e){let t=i.position||"after_char";n[t]?n[t].push(i):n.after_char.push(i)}for(let i in n)n[i].sort((t,s)=>(t.order||0)-(s.order||0));return Object.entries(n).filter(([i,t])=>t.length>0).map(([i,t])=>({position:i,entries:t}))}createActivatedEntry(e,n,i,t){let s={...e,matchedKeys:n,depth:i,activationScore:this.calculateActivationScore(e,t.text,n),activationTime:t.currentTime},r=t.currentTime??Date.now(),o={time:r,stickyUntil:e.sticky?r+e.sticky*1e3:void 0,cooldownUntil:e.cooldown?r+e.cooldown*1e3:void 0};return this.activationHistory.set(e.id,o),s}matchKeys(e,n){let i=[],t=e.caseSensitive??this.settings.caseSensitive??!1,s=e.matchWholeWords??this.settings.matchWholeWords??!1;for(let r of e.keys||[])this.textMatch(n,r,{caseSensitive:t,wholeWords:s})&&i.push(r);return i}textMatch(e,n,i={}){let{caseSensitive:t=!1,wholeWords:s=!1}=i,r=t?e:this.toHalfWidth(e).toLowerCase(),o=t?n:this.toHalfWidth(n).toLowerCase();if(o.startsWith("/")&&o.lastIndexOf("/")>0)try{let a=o.lastIndexOf("/"),c=o.slice(1,a),l=o.slice(a+1)||(t?"":"i");return new RegExp(c,l).test(e)}catch{return!1}return this.hasCJK(o)||this.hasCJK(r)?r.includes(o):s?new RegExp(`\\b${this.escapeRegex(o)}\\b`,t?"":"i").test(e):r.includes(o)}calculateActivationScore(e,n,i){let t=0;e.constant&&(t+=1e3),t+=(e.priority||0)*100,t+=(e.order||0)*10;for(let s of i)t+=s.length;return e.probability!==void 0&&(t+=e.probability*50),t}calculateGroupBonus(e,n){return e.group?n.filter(t=>t.group===e.group).length*10:0}ensureMinimumActivations(e,n){return[]}calculateTotalTokens(e){return e.reduce((n,i)=>n+this.estimateTokens(i.content),0)}estimateTokens(e){return Math.ceil(e.length/4)}toHalfWidth(e){return e.replace(/[\uFF01-\uFF5E]/g,n=>String.fromCharCode(n.charCodeAt(0)-65248)).replace(/\u3000/g," ")}hasCJK(e){return/[\u3400-\u9FFF\uF900-\uFAFF]/.test(e||"")}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};return S(k);})();
