"use strict";var WorldBookKit=(()=>{var v=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var S=(p,t)=>{for(var i in t)v(p,i,{get:t[i],enumerable:!0})},E=(p,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of y(t))!A.call(p,e)&&e!==i&&v(p,e,{get:()=>t[e],enumerable:!(r=m(t,e))||r.enumerable});return p};var b=p=>E(v({},"__esModule",{value:!0}),p);var k={};S(k,{WorldBookEngine:()=>g});var g=class{constructor(t){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let i=t.seed>>>0||1;this.rand=()=>((i=1664525*i+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(t){this.runtimeOptions={...this.runtimeOptions,...t}}process(t,i){let r={...this.getDefaultSettings(),...t.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(r.recursiveScan=!!this.runtimeOptions.recursive);let e=this.activate({...t,settings:r},{scanText:i,chatHistory:[],generationType:"Normal"}),o=e.flatMap(n=>n.entries),s=o.map(n=>n.content).join(`
`),a=this.calculateTotalTokens(o);return{activatedEntries:o,slots:e,finalPrompt:s,totalTokens:a}}activate(t,i){this.tickTimedEffects();let r=t.settings||this.getDefaultSettings(),e=this.selectCandidates(t.entries,i,r);e=this.applyFilters(e,i,r),e=this.applyTimedEffects(e,r),e=this.applyProbability(e),e=this.resolveInclusionGroups(e),e=this.applyScoring(e,i,r),e=this.applyBudget(e,r);let o=e.some(a=>a.nonRecursable||a.blockFurther);this.commitTimedEffects(e);let s=!!r.recursiveScan&&(r.maxRecursionSteps??0)>0;return!o&&s?e=this.recursiveScan(e,t,i,r):!s&&(r.minActivations??0)>0&&(e=this.minActivationScan(e,t,i,r)),this.distributeToSlots(e)}selectCandidates(t,i,r){let e=[],o=i.scanText||"";for(let s of t){if(!(s.enabled!==!1))continue;if(s.constant){e.push(this.createActivatedEntry(s,[],0,i));continue}let n=this.matchKeys(s,o,r);if(n.length>0){let c=s.minActivations??r.minActivations??1;if(s.selectiveLogic){let l=s.selectiveLogic.includes("AND")?s.keys.length:1;n.length>=l&&e.push(this.createActivatedEntry(s,n,0,i))}else n.length>=c&&e.push(this.createActivatedEntry(s,n,0,i))}}return e}applyFilters(t,i,r){return t.filter(e=>{if(e.optionalFilter){let o=e.optionalFilter,s=e.caseSensitive??r.caseSensitive??!1,a=i.scanText||"",n=s?a:a.toLowerCase(),c=o.keys.map(f=>s?f:f.toLowerCase()).map(f=>n.includes(f));if(!(o.logic==="AND_ALL"?c.every(Boolean):o.logic==="NOT_ANY"?!c.some(Boolean):o.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let i of t){let r=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};i.sticky&&(r.stickyRemaining=i.sticky),i.cooldown&&(r.cooldownRemaining=i.cooldown),this.timedEffectsState.set(i.id,r)}}applyTimedEffects(t,i){let r=[],e=i?.chatHistory?.length??0;for(let o of t){let s=this.timedEffectsState.get(o.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(o.delay&&e<o.delay||s.cooldownRemaining>0)continue;let a={...o};s.stickyRemaining>0&&(a.stickyRemaining=s.stickyRemaining),r.push(a)}return r}applyScoring(t,i,r){for(let e of t){let o=0;e.constant&&(o+=1e3),o+=(e.priority||0)*100,o+=(e.order||0)*10;for(let s of e.matchedKeys)o+=s.length;if(e.probability!==void 0&&(o+=e.probability*50),e.activationScore=o,e.score=o,r.useGroupScoring&&e.group){let s=this.calculateGroupBonus(e,t);e.groupScore=s,e.activationScore+=s}}return t.sort((e,o)=>(o.activationScore||0)-(e.activationScore||0))}getProb(t){let i=t?.probability??t?.useProbability??t?.prob;return(i==null||i===""||Number.isNaN(Number(i)))&&(i=100),i=Number(i),i<=1&&i>=0&&(i=i*100),i=Math.max(0,Math.min(100,i)),i}applyProbability(t){return t.filter(i=>i.stickyRemaining&&i.stickyRemaining>0?!0:this.rand()*100<=this.getProb(i))}recursiveScan(t,i,r,e){let o=[...t],s=new Set(o.map(n=>n.id)),a=1;for(;a<=(e.maxRecursionSteps??2);){let n=o.map(u=>u.content).join(`
`),c=[];for(let u of i.entries){if(s.has(u.id)||u.delayLevel&&a<u.delayLevel)continue;let d=this.matchKeys(u,n,e);d.length>0&&c.push({...u,matchedKeys:d,recursionLevel:a,score:d.length,depth:a,activationScore:d.length})}if(c.length===0)break;let l=c.some(u=>u.nonRecursable||u.blockFurther),f=this.resolveInclusionGroups(c);if(f=this.applyProbability(f),o.push(...f),f.forEach(u=>s.add(u.id)),l||f.some(u=>u.blockFurther))break;a++}return o}applyBudget(t,i){let r=i.tokenBudget??2e3,e=i.contextPercent??.7,o=Math.floor(r*e),s=0,a=[];t.sort((n,c)=>(c.activationScore||0)-(n.activationScore||0));for(let n of t){let c=this.estimateTokens(n.content);if(s+c<=o)a.push(n),s+=c;else break}return a}distributeToSlots(t){let i=new Map;for(let n of t){let c=`${n.position||"after_char"}_${n.depth||0}_${n.role||"system"}`;i.has(c)||i.set(c,{position:n.position||"after_char",depth:n.depth,role:n.role,entries:[]}),i.get(c).entries.push(n)}for(let n of i.values())n.entries.sort((c,l)=>{let f=c.order??0,u=l.order??0;return f!==u?f-u:(c.id??"").localeCompare(l.id??"")});let r=n=>n==="system"?0:n==="user"?1:2,e={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},o=0,s=new Map;for(let n of i.values())s.set(n,o++);return Array.from(i.values()).sort((n,c)=>{let l=e[n.position]??5,f=e[c.position]??5;if(l!==f)return l-f;let u=n.depth??0,d=c.depth??0;if(u!==d)return u-d;let h=r(n.role)-r(c.role);return h!==0?h:s.get(n)-s.get(c)})}createActivatedEntry(t,i,r,e){return{...t,matchedKeys:i,depth:r,activationScore:this.calculateActivationScore(t,e.scanText||"",i),activationTime:Date.now()}}matchKeys(t,i,r){let e=[],o=t.caseSensitive??r?.caseSensitive??!1,s=t.matchWholeWords??r?.matchWholeWords??!1;for(let a of t.keys||[]){let n=o?i:i.toLowerCase(),c=o?a:a.toLowerCase();s?this.makeWholeWordRegex(a,o).test(i)&&e.push(a):n.includes(c)&&e.push(a)}return e}containsCJK(t){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(t)}makeWholeWordRegex(t,i){let r=i?"g":"gi";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),r):new RegExp(`(^|\\W)${this.escapeRegex(t)}(\\W|$)`,r)}textMatch(t,i,r={}){let{caseSensitive:e=!1,wholeWords:o=!1}=r;if(i.startsWith("/")&&i.lastIndexOf("/")>0)try{let n=i.lastIndexOf("/"),c=i.slice(1,n),l=i.slice(n+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let s=e?t:t.toLowerCase(),a=e?i:i.toLowerCase();if(o){if(this.makeWholeWordRegex(a,e).test(t))return!0}else if(s.includes(a))return!0;return!1}calculateActivationScore(t,i,r){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let o of r)e+=o.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,i){return t.group?i.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let i=new Map,r=[];for(let o of t){let s=o.inclusionGroup||o.group;if(s){let a=i.get(s)??[];a.push(o),i.set(s,a)}else r.push(o)}let e=[];for(let[,o]of i){let s=this.selectFromGroup(o);s&&e.push(s)}return[...e,...r]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let i=t.some(a=>a.useGroupScoring),r=t.some(a=>a.prioritizeInclusion),e=t;if(i){let a=Math.max(...e.map(n=>n.score??0));e=e.filter(n=>(n.score??0)===a)}if(r)return e.reduce((a,n)=>{let c=a.priority??0,l=n.priority??0;return c!==l?l>c?n:a:(n.order??0)>(a.order??0)?n:a});let o=e.reduce((a,n)=>a+(n.groupWeight??100),0),s=this.rand()*o;for(let a of e)if(s-=a.groupWeight??100,s<=0)return a;return e[0]}minActivationScan(t,i,r,e){let o=e.minActivations??1;if(t.length>=o)return t;let s=o-t.length,a=i.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));a.sort((c,l)=>(l.priority||0)-(c.priority||0));let n=[];for(let c=0;c<Math.min(s,a.length);c++){let l=a[c];n.push(this.createActivatedEntry(l,[],0,r))}return[...t,...n]}calculateTotalTokens(t){return t.reduce((i,r)=>i+this.estimateTokens(r.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};return b(k);})();
