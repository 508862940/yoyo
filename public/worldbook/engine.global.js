"use strict";var WorldBookKit=(()=>{var v=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var S=(p,t)=>{for(var i in t)v(p,i,{get:t[i],enumerable:!0})},E=(p,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of y(t))!A.call(p,e)&&e!==i&&v(p,e,{get:()=>t[e],enumerable:!(n=m(t,e))||n.enumerable});return p};var b=p=>E(v({},"__esModule",{value:!0}),p);var k={};S(k,{WorldBookEngine:()=>g});var g=class{constructor(t){this.timedEffectsState=new Map;this.rand=Math.random;this.runtimeOptions={};if(t?.random)this.rand=t.random;else if(typeof t?.seed=="number"){let i=t.seed>>>0||1;this.rand=()=>((i=1664525*i+1013904223>>>0)&4294967295)/4294967296}this.settings=this.getDefaultSettings()}getDefaultSettings(){return{scanDepth:1e3,recursive:!0,minActivations:1,maxDepth:3,maxRecursionSteps:10,tokenBudget:2e3,matchWholeWords:!1,caseSensitive:!1,contextPercent:.7,useGroupScoring:!0,prioritizeInclusion:!1,recursiveScan:!0}}setOptions(t){this.runtimeOptions={...this.runtimeOptions,...t}}process(t,i){let n={...this.getDefaultSettings(),...t.settings||{},...this.runtimeOptions||{}};typeof this.runtimeOptions?.recursive=="boolean"&&(n.recursiveScan=!!this.runtimeOptions.recursive);let e=this.activate({...t,settings:n},{scanText:i,chatHistory:[],generationType:"Normal"}),o=e.flatMap(s=>s.entries),a=o.map(s=>s.content).join(`
`),r=this.calculateTotalTokens(o);return{activatedEntries:o,slots:e,finalPrompt:a,totalTokens:r}}activate(t,i){this.tickTimedEffects();let n=t.settings||this.getDefaultSettings(),e=this.selectCandidates(t.entries,i,n);e=this.applyFilters(e,i,n),e=this.applyTimedEffects(e,n),e=this.applyProbability(e),e=this.resolveInclusionGroups(e),e=this.applyScoring(e,i,n),e=this.applyBudget(e,n);let o=e.some(r=>r.nonRecursable||r.blockFurther);this.commitTimedEffects(e);let a=!!n.recursiveScan&&(n.maxRecursionSteps??0)>0;return!o&&a?e=this.recursiveScan(e,t,i,n):!a&&(n.minActivations??0)>0&&(e=this.minActivationScan(e,t,i,n)),this.distributeToSlots(e)}selectCandidates(t,i,n){let e=[],o=i.scanText||"";for(let a of t){if(!a.enabled)continue;if(a.constant){e.push(this.createActivatedEntry(a,[],0,i));continue}let r=this.matchKeys(a,o,n);if(r.length>0){let s=a.minActivations??n.minActivations??1;if(a.selectiveLogic){let c=a.selectiveLogic.includes("AND")?a.keys.length:1;r.length>=c&&e.push(this.createActivatedEntry(a,r,0,i))}else r.length>=s&&e.push(this.createActivatedEntry(a,r,0,i))}}return e}applyFilters(t,i,n){return t.filter(e=>{if(e.optionalFilter){let o=e.optionalFilter,a=e.caseSensitive??n.caseSensitive??!1,r=i.scanText||"",s=a?r:r.toLowerCase(),c=o.keys.map(f=>a?f:f.toLowerCase()).map(f=>s.includes(f));if(!(o.logic==="AND_ALL"?c.every(Boolean):o.logic==="NOT_ANY"?!c.some(Boolean):o.logic==="NOT_ALL"?!c.every(Boolean):c.some(Boolean)))return!1}return!0})}tickTimedEffects(){for(let t of this.timedEffectsState.values())t.stickyRemaining>0&&t.stickyRemaining--,t.cooldownRemaining>0&&t.cooldownRemaining--}commitTimedEffects(t){for(let i of t){let n=this.timedEffectsState.get(i.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};i.sticky&&(n.stickyRemaining=i.sticky),i.cooldown&&(n.cooldownRemaining=i.cooldown),this.timedEffectsState.set(i.id,n)}}applyTimedEffects(t,i){let n=[],e=i?.chatHistory?.length??0;for(let o of t){let a=this.timedEffectsState.get(o.id)||{stickyRemaining:0,cooldownRemaining:0,messagesSeen:0};if(o.delay&&e<o.delay||a.cooldownRemaining>0)continue;let r={...o};a.stickyRemaining>0&&(r.stickyRemaining=a.stickyRemaining),n.push(r)}return n}applyScoring(t,i,n){for(let e of t){let o=0;e.constant&&(o+=1e3),o+=(e.priority||0)*100,o+=(e.order||0)*10;for(let a of e.matchedKeys)o+=a.length;if(e.probability!==void 0&&(o+=e.probability*50),e.activationScore=o,e.score=o,n.useGroupScoring&&e.group){let a=this.calculateGroupBonus(e,t);e.groupScore=a,e.activationScore+=a}}return t.sort((e,o)=>(o.activationScore||0)-(e.activationScore||0))}getProb(t){let i=t?.probability??t?.useProbability??t?.prob;return(i==null||i===""||Number.isNaN(Number(i)))&&(i=100),i=Number(i),i<=1&&i>=0&&(i=i*100),i=Math.max(0,Math.min(100,i)),i}applyProbability(t){return t.filter(i=>i.stickyRemaining&&i.stickyRemaining>0?!0:this.rand()*100<=this.getProb(i))}recursiveScan(t,i,n,e){let o=[...t],a=new Set(o.map(s=>s.id)),r=1;for(;r<=(e.maxRecursionSteps??2);){let s=o.map(u=>u.content).join(`
`),c=[];for(let u of i.entries){if(a.has(u.id)||u.delayLevel&&r<u.delayLevel)continue;let d=this.matchKeys(u,s,e);d.length>0&&c.push({...u,matchedKeys:d,recursionLevel:r,score:d.length,depth:r,activationScore:d.length})}if(c.length===0)break;let l=c.some(u=>u.nonRecursable||u.blockFurther),f=this.resolveInclusionGroups(c);if(f=this.applyProbability(f),o.push(...f),f.forEach(u=>a.add(u.id)),l||f.some(u=>u.blockFurther))break;r++}return o}applyBudget(t,i){let n=i.tokenBudget??2e3,e=i.contextPercent??.7,o=Math.floor(n*e),a=0,r=[];t.sort((s,c)=>(c.activationScore||0)-(s.activationScore||0));for(let s of t){let c=this.estimateTokens(s.content);if(a+c<=o)r.push(s),a+=c;else break}return r}distributeToSlots(t){let i=new Map;for(let s of t){let c=`${s.position||"after_char"}_${s.depth||0}_${s.role||"system"}`;i.has(c)||i.set(c,{position:s.position||"after_char",depth:s.depth,role:s.role,entries:[]}),i.get(c).entries.push(s)}for(let s of i.values())s.entries.sort((c,l)=>{let f=c.order??0,u=l.order??0;return f!==u?f-u:(c.id??"").localeCompare(l.id??"")});let n=s=>s==="system"?0:s==="user"?1:2,e={before_an:0,before_char:1,before_example:2,at_depth:3,after_example:4,after_char:5,after_an:6},o=0,a=new Map;for(let s of i.values())a.set(s,o++);return Array.from(i.values()).sort((s,c)=>{let l=e[s.position]??5,f=e[c.position]??5;if(l!==f)return l-f;let u=s.depth??0,d=c.depth??0;if(u!==d)return u-d;let h=n(s.role)-n(c.role);return h!==0?h:a.get(s)-a.get(c)})}createActivatedEntry(t,i,n,e){return{...t,matchedKeys:i,depth:n,activationScore:this.calculateActivationScore(t,e.scanText||"",i),activationTime:Date.now()}}matchKeys(t,i,n){let e=[],o=t.caseSensitive??n?.caseSensitive??!1,a=t.matchWholeWords??n?.matchWholeWords??!1;for(let r of t.keys||[]){let s=o?i:i.toLowerCase(),c=o?r:r.toLowerCase();a?this.makeWholeWordRegex(r,o).test(i)&&e.push(r):s.includes(c)&&e.push(r)}return e}containsCJK(t){return/[\u4e00-\u9fff\u3400-\u4dbf\uf900-\ufaff\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af]/.test(t)}makeWholeWordRegex(t,i){let n=i?"g":"gi";return this.containsCJK(t)?new RegExp(this.escapeRegex(t),n):new RegExp(`(^|\\W)${this.escapeRegex(t)}(\\W|$)`,n)}textMatch(t,i,n={}){let{caseSensitive:e=!1,wholeWords:o=!1}=n;if(i.startsWith("/")&&i.lastIndexOf("/")>0)try{let s=i.lastIndexOf("/"),c=i.slice(1,s),l=i.slice(s+1)||(e?"":"i");return new RegExp(c,l).test(t)}catch{return!1}let a=e?t:t.toLowerCase(),r=e?i:i.toLowerCase();if(o){if(this.makeWholeWordRegex(r,e).test(t))return!0}else if(a.includes(r))return!0;return!1}calculateActivationScore(t,i,n){let e=0;t.constant&&(e+=1e3),e+=(t.priority||0)*100,e+=(t.order||0)*10;for(let o of n)e+=o.length;return t.probability!==void 0&&(e+=t.probability*50),e}calculateGroupBonus(t,i){return t.group?i.filter(e=>e.group===t.group).length*10:0}resolveInclusionGroups(t){let i=new Map,n=[];for(let o of t){let a=o.inclusionGroup||o.group;if(a){let r=i.get(a)??[];r.push(o),i.set(a,r)}else n.push(o)}let e=[];for(let[,o]of i){let a=this.selectFromGroup(o);a&&e.push(a)}return[...e,...n]}selectFromGroup(t){if(!t.length)return null;if(t.length===1)return t[0];let i=t.some(r=>r.useGroupScoring),n=t.some(r=>r.prioritizeInclusion),e=t;if(i){let r=Math.max(...e.map(s=>s.score??0));e=e.filter(s=>(s.score??0)===r)}if(n)return e.reduce((r,s)=>{let c=r.priority??0,l=s.priority??0;return c!==l?l>c?s:r:(s.order??0)>(r.order??0)?s:r});let o=e.reduce((r,s)=>r+(s.groupWeight??100),0),a=this.rand()*o;for(let r of e)if(a-=r.groupWeight??100,a<=0)return r;return e[0]}minActivationScan(t,i,n,e){let o=e.minActivations??1;if(t.length>=o)return t;let a=o-t.length,r=i.entries.filter(c=>c.enabled&&!t.some(l=>l.id===c.id));r.sort((c,l)=>(l.priority||0)-(c.priority||0));let s=[];for(let c=0;c<Math.min(a,r.length);c++){let l=r[c];s.push(this.createActivatedEntry(l,[],0,n))}return[...t,...s]}calculateTotalTokens(t){return t.reduce((i,n)=>i+this.estimateTokens(n.content),0)}estimateTokens(t){return Math.ceil(t.length/4)}escapeRegex(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}};return b(k);})();
